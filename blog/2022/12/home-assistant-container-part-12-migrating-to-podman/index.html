<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><title itemprop=name>Home Assistant Container Part 12: Migrating to Podman :: Sequr</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="noodp, noydir"><meta name=googlebot content="noodp, noydir"><link rel=canonical href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/ itemprop=url><meta name=url content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/"><link rel=icon href=/favicon.ico><meta itemprop=name content="Home Assistant Container Part 12: Migrating to Podman"><meta itemprop=description content="We’re restarting from the beginning using Podman instead of Docker (Compose)"><meta itemprop=datePublished content="2022-12-02T00:00:00+01:00"><meta itemprop=dateModified content="2024-09-05T00:00:00+02:00"><meta itemprop=wordCount content="5368"><meta itemprop=image content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,Container,Docker,Podman,Fedora"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/cover.png"><meta name=twitter:title content="Home Assistant Container Part 12: Migrating to Podman"><meta name=twitter:description content="We’re restarting from the beginning using Podman instead of Docker (Compose)"><meta property="og:url" content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/"><meta property="og:site_name" content="Sequr"><meta property="og:title" content="Home Assistant Container Part 12: Migrating to Podman"><meta property="og:description" content="We’re restarting from the beginning using Podman instead of Docker (Compose)"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-12-02T00:00:00+01:00"><meta property="article:modified_time" content="2024-09-05T00:00:00+02:00"><meta property="article:tag" content="Home Automation"><meta property="article:tag" content="Home Assistant"><meta property="article:tag" content="Container"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Podman"><meta property="article:tag" content="Fedora"><meta property="og:image" content="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/cover.png"><meta property="og:see_also" content="https://sequr.be/blog/2024/02/home-assistant-container-part-13-vs-code-code-server/"><meta property="og:see_also" content="https://sequr.be/blog/2022/11/home-assistant-container-part-11-bluetooth-support/"><meta property="og:see_also" content="https://sequr.be/blog/2022/10/home-assistant-container-part-10-zigbee2mqtt/"><meta property="og:see_also" content="https://sequr.be/blog/2022/09/home-assistant-container-part-9-esphome/"><meta property="og:see_also" content="https://sequr.be/blog/2022/09/home-assistant-container-part-8-update-home-assistant-container/"><meta property="og:see_also" content="https://sequr.be/blog/2022/09/home-assistant-container-part-7-backing-up-home-assistant-container/"><meta name=description content="We&rsquo;re restarting from the beginning using Podman instead of Docker (Compose)"><meta itemprop=description content="We&rsquo;re restarting from the beginning using Podman instead of Docker (Compose)"><meta property="og:updated_time" content="2024-09-05T00:00:00+02:00"><link rel=sitemap type=application/xml title=Sitemap href=https://sequr.be/sitemap.xml><meta name=apple-mobile-web-app-title content="Sequr"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><link rel=stylesheet href=/css/bundle.min.fcaa303b2ba3fbaa95b102dfd06e53ba0d671cfc2e6c076625e31dd5f3133ae8.css integrity="sha256-/KowOyuj+6qVsQLf0G5Tug1nHPwubAdmJeMd1fMTOug=" crossorigin=anonymous><script defer type=text/javascript src=/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js integrity="sha256-FFRTJhp3VfUEKoVMQhNQHSFaj740wI0YHED4A/ExXnQ=" crossorigin=anonymous></script></head><body class=dark-theme><div class=wrapper><aside class="sidebar h-card background-image"><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class="sidebar-about hcard"><h1 class=brand><a href=https://sequr.be/><img src=/logo.png class="u-logo u-photo" alt="Sequr brand image">
</a><a href=https://sequr.be/ class="u-url p-org"><h1>Sequr</h1></a></h1><p class="lead p-note">Writeups and random stuff about infosec and life</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/ title=About>About</a></li><li class=heading><a href=/blog/ title=Blog>Blog</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://sequr.be/blog/2024/09/flashing-the-ikea-vindriktning-with-tasmota-and-esphome/ title="Flashing the IKEA Vindriktning with Tasmota and ESPHome">IKEA Vindriktning in HA</a></li><li class=bullet><a href=https://sequr.be/blog/2024/02/home-assistant-container-part-13-vs-code-code-server/ title="Home Assistant Container Part 13: VS Code code-server">HA Containter pt13: VS Code</a></li><li class=bullet><a href=https://sequr.be/blog/2024/02/flash-xiaomi-lywsd03mmc-ble-sensor-with-zigbee-firmware/ title="Flash Xiaomi LYWSD03MMC BLE sensor with Zigbee firmware">Xiaomi LYWSD03MMC with Zigbee</a></li><li class=bullet><a href=https://sequr.be/blog/2023/12/remotely-opening-and-closing-my-gate/ title="Remotely opening and closing my gate">HA gate controller</a></li><li class=bullet><a href=https://sequr.be/blog/2023/10/2-months-in/ title="2 months in">2 months in</a></li><li class=heading><a href=/shoppinglist/ title=Shopping>Shopping</a></li><li class=heading><a href=/privacy/ title=Privacy>Privacy</a></li></ul></nav><a target=_blank class=social title="RSS Feed" href=/blog/index.xml><svg width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg>
</a><a href=https://bsky.app/profile/sequr.be target=_blank class="u-url social" rel="external noopener me" title=Bluesky><svg width="1.2em" height="1.2em" viewBox="0 0 568 501"><path fill="currentcolor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873c25.719-53.192 95.759-152.3204 160.879-201.2093C491.866-1.61183 568-28.9064 568 57.9464 568 75.2916 558.055 203.659 552.222 224.501c-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281C285.169 375.812 284.017 372.431 284 375.306 283.983 372.431 282.831 375.812 280.369 383.039c-13.43 39.422-65.842 193.273-185.7023 70.281C31.5556 388.56 60.7778 323.8 175.653 304.249 109.933 315.434 36.0535 296.954 15.7778 224.501 9.94525 203.659.0 75.2916.0 57.9464.0-28.9064 76.1345-1.61183 123.121 33.6637z"/></svg></a><a href=https://mastodon-belgium.be/@TerraGloba target=_blank class="u-url social" rel="external noopener me" title=Mastodon><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><path fill="currentcolor" d="M20.94 14c-.28 1.41-2.44 2.96-4.97 3.26-1.31.15-2.6.3-3.97.24-2.25-.11-4-.54-4-.54v.62c.32 2.22 2.22 2.35 4.03 2.42 1.82.05 3.44-.46 3.44-.46l.08 1.65s-1.28.68-3.55.81c-1.25.07-2.81-.03-4.62-.5-3.92-1.05-4.6-5.24-4.7-9.5l-.01-3.43c0-4.34 2.83-5.61 2.83-5.61C6.95 2.3 9.41 2 11.97 2h.06c2.56.0 5.02.3 6.47.96.0.0 2.83 1.27 2.83 5.61.0.0.04 3.21-.39 5.43M18 8.91c0-1.08-.3-1.91-.85-2.56-.56-.63-1.3-.96-2.23-.96-1.06.0-1.87.41-2.42 1.23l-.5.88-.5-.88c-.56-.82-1.36-1.23-2.43-1.23-.92.0-1.66.33-2.23.96C6.29 7 6 7.83 6 8.91v5.26h2.1V9.06c0-1.06.45-1.62 1.36-1.62 1 0 1.5.65 1.5 1.93v2.79h2.07V9.37c0-1.28.5-1.93 1.51-1.93.9.0 1.35.56 1.35 1.62v5.11H18V8.91z"/></svg></a><a href=https://github.com/TheGroundZero target=_blank class="u-url social" rel="external noopener me" title=Github><svg width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a href=https://twitter.com/DezeStijn target=_blank class="u-url social" rel="external noopener me" title=Twitter><svg width="1.2em" height="1.2em" viewBox="0 0 16 16"><path fill="currentcolor" d="M5.032 14.286c6.037.0 9.34-4.837 9.34-9.032.0-.137.0-.274-.01-.41A6.56 6.56.0 0016 3.2c-.6.256-1.235.425-1.885.5a3.207 3.207.0 001.443-1.757c-.645.37-1.35.63-2.085.77a3.322 3.322.0 00-1.862-.958 3.384 3.384.0 00-2.082.334 3.223 3.223.0 00-1.442 1.49 3.08 3.08.0 00-.208 2.03 9.57 9.57.0 01-3.747-.963A9.269 9.269.0 011.114 2.292a3.086 3.086.0 00-.36 2.314c.189.787.68 1.475 1.376 1.924A3.344 3.344.0 01.64 6.132v.04c0 .734.263 1.444.743 2.01a3.3 3.3.0 001.89 1.102c-.483.128-.99.146-1.482.055a3.19 3.19.0 001.168 1.577 3.36 3.36.0 001.9.627A6.732 6.732.0 010 12.86a9.527 9.527.0 005.032 1.423"/></svg></a><a href=https://ko-fi.com/s4squatch target=_blank class="u-url social" rel="external noopener" title=Kofi><svg width="1.2em" height="1.2em" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604.0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407.0.0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311zm6.173.478c-.928.116-1.682.028-1.682.028V7.284h1.77s1.971.551 1.971 2.638c0 1.913-.985 2.667-2.059 3.015z"/></svg></a><p class=footnote>&copy; 2019
• <a class="p-name u-url" href=https://sequr.be>Sequr</a>
• <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="external noopener">CC BY-NC-SA 4.0</a></p></div></aside><section class="content container"><article class="post h-entry"><header class=info><h1 class="post-title p-name u-url"><a href=https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/>Home Assistant Container Part 12: Migrating to Podman</a></h1><div class=headline><div><span class="h-card p-author">DezeStijn
</span><span class=whitespace>• </span><time datetime=2022-12-02T00:00:00+0100 class="post-date dt-published">Dec 2, 2022
</time><span class=whitespace></span><time datetime=2024-09-05T00:00:00+0200 class="post-date dt-updated">(Sep 5, 2024)
</time><span class=whitespace>• </span><span class=reading-time><span>26 mins read</span></span></div><ul class=tags><li class="tag-Home Automation"><a class=p-category href=https://sequr.be/categories/home-automation>Home Automation</a></li><li class="tag-HA Container"><a class=p-category href=https://sequr.be/categories/ha-container>HA Container</a></li></ul></div><p class=seriesname>Series: <a class=p-category href=https://sequr.be/series/ha-container>HA Container</a></p></header><main class=e-content><h2 id=intro>Intro</h2><p>From the <a href=https://docs.podman.io/en/latest/ title="Podman documentation" rel=external target=_blank>Podman documentation</a>:</p><blockquote><p>Podman is a daemonless, open source, Linux native tool designed to make it easy to find, run, build, share and deploy applications using Open Containers Initiative (OCI) Containers and Container Images.
Podman provides a command line interface (CLI) familiar to anyone who has used the Docker Container Engine. Most users can simply alias Docker to Podman <em>(alias docker=podman)</em> without any problems.
Similar to other common Container Engines (Docker, CRI-O, containerd), Podman relies on an OCI compliant Container Runtime (runc, crun, runv, etc) to interface with the operating system and create the running containers.
This makes the running containers created by Podman nearly indistinguishable from those created by any other common container engine.</p></blockquote><p>In a timespan of 2 or 3 days my no-brand M.2 SSD crapped itself, destroying my HA Container setup with it, and we had a discussion at work re. Docker licenses and open-source alternatives, Podman being one of them.
These events made me decide to start over with a new Podman-based setup of Home Assistant Container as soon as my newly ordered Crucial SATA SSD had arrived.
Sadly I didn&rsquo;t have the chance to document my the changes I did to my Docker setup using macvlan&rsquo;s. I would have loved to share that as well.</p><p>This blog post will be kind of a logbook of the steps I&rsquo;ve taken to set everything up.
Most &ndash; if not all &ndash; will be based on a topic in the HA forums: <a href=https://community.home-assistant.io/t/work-in-progress-configuration-for-running-a-home-assistant-in-containers-with-systemd-and-podman-on-fedora-iot title="Work in progress: configuration for running a Home Assistant in containers with systemd and podman on Fedora IoT" rel=external target=_blank>Work in progress: configuration for running a Home Assistant in containers with systemd and podman on Fedora IoT</a>.</p><p>Note that this does not negate anything we did so far in the <a href=/categories/ha-container/ title="HA Container series">Home Assistant Container series</a> so far and you&rsquo;re still free to use Docker Compose to do your setup.</p><h2 id=fedora-core-os>Fedora Core OS</h2><figure class=center><img src=fedora-coreos-logo.png alt="Fedora CoreOS logo"><figcaption class=center>Fedora CoreOS</figcaption></figure><p>I&rsquo;m no linux/unix expert and so far I&rsquo;ve been running mainly Debian and Ubuntu VMs.
But as I&rsquo;m already making things complicated for myself by starting from scratch and learning to work with a new container manager as I go, I decided to make it extra hard on myself and learn how to work with <a href=https://getfedora.org/en/coreos title="Fedora CoreOS" rel=external target=_blank>Fedora CoreOS</a> as well.</p><blockquote><p>Fedora CoreOS is an automatically-updating, minimal operating system for running containerized workloads securely and at scale.
It is currently available on multiple platforms, with more coming soon.</p></blockquote><p>Fedora CoreOS also comes with Docker and Podman installed by default.</p><p>I installed Fedora CoreOS bare-metal on my <a href=https://s.click.aliexpress.com/e/_DkZ6gPh title="Beelink Mini S with Intel 11th Gen N5095 CPU" rel=external target=_blank>Beelink</a> (after installing a new SSD) using the Live USB image.</p><h3 id=preparing-live-usb>Preparing Live USB</h3><ol><li><a href="https://getfedora.org/en/coreos/download?tab=metal_virtualized&amp;stream=stable&amp;arch=x86_64" title="Download Fedora CoreOS" rel=external target=_blank>Download</a> the Fedora Core OS Bare Metal ISO.<br>I recommend getting it from the Stable stream.</li><li>Follow the steps to verify your download.<br>Download the checksum file and signature, import Fedora&rsquo;s GPG key, verify the validity of the signature, and verify the checksum matches.<br>This way, you&rsquo;re certain your downloaded ISO isn&rsquo;t corrupted or altered along the way.</li><li>If you&rsquo;re on Linux or Mac, write the ISO image to your USB drive using <code>dd</code>.<br>Make sure you fully understand what you&rsquo;re doing here!<br><code>sudo dd bs=4M if=fedora-coreos-36.20221030.3.0-live.x86_64.iso of=/dev/sdb conv=fdatasync status=progress</code>
If you&rsquo;re on Windows, use a tool like balenaEtcher.</li></ol><p>Once the writing process is done, you can (safely) eject your USB drive from your computer and plug it in your target system.</p><h3 id=preparing-ignition-configuration>Preparing Ignition configuration</h3><p>Fedora doesn&rsquo;t come with default credentials.
So later, when we install Fedora CoreOS on our system, we won&rsquo;t be able to login on the console or over SSH.</p><p>To solve this, we&rsquo;ll create an Ignition configuration which will be read by the setup process and which we&rsquo;ll use to setup our account.</p><blockquote><p>Ignition is a provisioning utility that reads a configuration file (in JSON format) and provisions a Fedora CoreOS system based on that configuration.</p></blockquote><p>We start of by creating a Butane configuration file.
In this configuration file, we create 2 accounts <code>core</code> and <code>hass</code> with <a href=/blog/2020/09/upgrade-your-ssh-keys-to-ed25519/#upgrade-to-ed25519-keys title="Generate ED25 SSH keys">SSH keys</a>.
The <code>core</code> user is added to the <code>wheel</code> group so it gets sudo rights and the <code>hass</code> user is added to the <code>dialout</code> group.</p><p>We also add a systemd config that will download and launch <code>etcd</code> at boot.</p><blockquote><p><a href=https://etcd.io/ title="A distributed, reliable key-value store for the most critical data of a distributed system" rel=external target=_blank>etcd</a> is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines.
It gracefully handles leader elections during network partitions and can tolerate machine failure, even in the leader node.</p></blockquote><p>And we also setup auto-updates to not be too eager on updating and to only allow reboots in a specific timeslot.</p><p><code>fedoracore.be</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>variant</span>: <span style=color:#ae81ff>fcos</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.4.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>passwd</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>users</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>core</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ssh_authorized_keys</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>ssh-ed25519 AA...</span> <span style=color:#75715e># UPDATE THIS</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>groups</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>wheel</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hass</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ssh_authorized_keys</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>ssh-ed25519 AA...</span> <span style=color:#75715e># UPDATE THIS</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>groups</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>dialout</span>
</span></span><span style=display:flex><span><span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>files</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/etc/hostname</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>0644</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>inline: fedoracore  # Optional</span>: <span style=color:#ae81ff>change this</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># OPTIONAL - Wariness to updates</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># https://docs.fedoraproject.org/en-US/fedora-coreos/auto-updates/#_wariness_to_updates</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/etc/zincati/config.d/51-rollout-wariness.toml</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>inline</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [identity]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          rollout_wariness = 0.75</span>          
</span></span><span style=display:flex><span>      <span style=color:#75715e># OPTIONAL - Update Strategy</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># https://coreos.github.io/zincati/usage/updates-strategy/</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/etc/zincati/config.d/55-updates-strategy.toml</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>inline</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [updates]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          strategy = &#34;periodic&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [[updates.periodic.window]]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          days = [ &#34;Sat&#34;, &#34;Sun&#34; ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          start_time = &#34;22:45&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          length_minutes = 60</span>          
</span></span><span style=display:flex><span><span style=color:#f92672>systemd</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>units</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>etcd-member.service</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Description=Run a single node etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        After=network-online.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Wants=network-online.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStartPre=mkdir -p /var/lib/etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStartPre=-/bin/podman kill etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStartPre=-/bin/podman rm etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStartPre=-/bin/podman pull quay.io/coreos/etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStart=/bin/podman run --name etcd --net=host \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    --volume /var/lib/etcd:/etcd-data:z  \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    quay.io/coreos/etcd:latest /usr/local/bin/etcd              \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --data-dir /etcd-data --name node1                  \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --initial-advertise-peer-urls http://127.0.0.1:2380 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --listen-peer-urls http://127.0.0.1:2380            \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --advertise-client-urls http://127.0.0.1:2379       \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --listen-client-urls http://127.0.0.1:2379          \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                            --initial-cluster node1=http://127.0.0.1:2380
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ExecStop=/bin/podman stop etcd
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        WantedBy=multi-user.target</span>        
</span></span></code></pre></div><p>To convert this Butane configuration file into an Ignition config, we need the Butane tool.
There are multiple methods to get Butane, like using a Podman <a href=https://quay.io/repository/coreos/butane title=coreos/butane rel=external target=_blank>container</a> or by using a distribution-provided package, but I opted for the <a href=https://github.com/coreos/butane/releases title="Butane releases" rel=external target=_blank>standalone</a> executable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://getfedora.org/static/fedora.gpg | gpg --import
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Check latest version at https://github.com/coreos/butane/releases</span>
</span></span><span style=display:flex><span>wget https://github.com/coreos/butane/releases/download/v0.16.0/butane-x86_64-unknown-linux-gnu
</span></span><span style=display:flex><span>wget https://github.com/coreos/butane/releases/download/v0.16.0/butane-x86_64-unknown-linux-gnu.asc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gpg --verify butane-x86_64-unknown-linux-gnu.asc
</span></span></code></pre></div><p>Finally to convert the configuration file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>chmod u+x butane-x86_64-unknown-linux-gnu
</span></span><span style=display:flex><span>./butane-x86_64-unknown-linux-gnu --pretty --strict fedoracore.be | tee fedoracore.ign
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;ignition&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;3.3.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;passwd&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;users&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;groups&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;wheel&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;core&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sshAuthorizedKeys&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;ssh-ed25519 AA...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;groups&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;dialout&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;hass&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sshAuthorizedKeys&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;ssh-ed25519 AA...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;storage&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;files&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/etc/hostname&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;contents&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;compression&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;data:,fedoracore&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#ae81ff>420</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;systemd&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;units&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;contents&#34;</span>: <span style=color:#e6db74>&#34;[Unit]\nDescription=Run a single node etcd\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nExecStartPre=mkdir -p /var/lib/etcd\nExecStartPre=-/bin/podman kill etcd\nExecStartPre=-/bin/podman rm etcd\nExecStartPre=-/bin/podman pull quay.io/coreos/etcd\nExecStart=/bin/podman run --name etcd --net=host \\\n            --volume /var/lib/etcd:/etcd-data:z  \\\n            quay.io/coreos/etcd:latest /usr/local/bin/etcd              \\\n                    --data-dir /etcd-data --name node1                  \\\n                    --initial-advertise-peer-urls http://127.0.0.1:2380 \\\n                    --listen-peer-urls http://127.0.0.1:2380            \\\n                    --advertise-client-urls http://127.0.0.1:2379       \\\n                    --listen-client-urls http://127.0.0.1:2379          \\\n                    --initial-cluster node1=http://127.0.0.1:2380\nExecStop=/bin/podman stop etcd\n\n[Install]\nWantedBy=multi-user.target\n&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;enabled&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;etcd-member.service&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>We will need to make this configuration file available to our system over the network.
Either by hosting it locally on a (temporary) webserver or by hosting it online.</p><p>I opted to use a temporary file host service named tmpfiles.org.
This is not an endorsement of this service.
Always be cautious when sharing/uploading configurations with potentially sensitive information (like SSH pubkeys) with an unknown 3rd party!</p><h3 id=installing-fedora-coreos>Installing Fedora CoreOS</h3><p>Now we&rsquo;re ready to install Fedora on our system via the Live USB.</p><ol><li>Plug the USB in the target system.</li><li>Power up the system and spam the <code>ESC</code> button on your keyboard.</li><li>Make sure you boot from USB.</li><li>Confirm the path of the system&rsquo;s hard drive (probably <code>/dev/sda</code>).<br><code>sudo fdisk -l</code></li><li>Run the following command in the terminal to launch the installer.<br>Don&rsquo;t forget to modify the url to your Ignition config.<br><code>sudo coreos-installer install /dev/sda --ignition-url https://example.com/example.ign</code></li><li>Once the installer has finished, reboot the system and unplug the USB.<br><code>sudo reboot</code></li></ol><h3 id=finishing-touches>Finishing touches</h3><p>Now you can SSH into Fedora system from your own computer.</p><p><code>ssh -i ~/.ssh/id_fc_core core@IP.OF.YOUR.BOX</code></p><h4 id=linger>Linger</h4><p>We&rsquo;ll be setting up our containers using systemd.
To keep systemd from stopping all of your containers when you log out, we enable <em>linger</em> on the <code>hass</code> account.</p><p><code>sudo loginctl enable-linger hass</code></p><h4 id=directory-structure>Directory structure</h4><p>Local config will be stored in <code>/srv/hass/</code>.
Grouping everything in one folder makes backing up also a lot easier.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir /srv/hass
</span></span><span style=display:flex><span>sudo chown -R hass:hass /srv/hass
</span></span></code></pre></div><h2 id=podman-setup>Podman setup</h2><figure class=center><img src=podman-logo.svg alt="Podman logo"><figcaption class=center>Podman</figcaption></figure><p>All Podman config will be done as the <code>hass</code> user.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -i ~/.ssh/id_ed25519_fc_hass hass@&lt;ip.of.your.systen&gt;
</span></span></code></pre></div><p>Still following the guide from the HA Forum, we&rsquo;ll be setting up multiple containers.</p><p>This includes a Certbot and Nginx reverse proxy container to provide external access to your Home Assistance instance.
If you prefer to setup remote access via the Nabu Casa cloud, you won&rsquo;t need these.</p><h3 id=podman-autoupdate>Podman Autoupdate</h3><p>Podman has an auto-update feature which is triggered via a timer.
We&rsquo;ll enable this in our user session as that&rsquo;s where we&rsquo;ll be running our rootless containers in.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now podman-auto-update.timer
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/timers.target.wants/podman-auto-update.timer → /usr/lib/systemd/user/podman-auto-update.timer.
</span></span></code></pre></div><h2 id=podman-containers>Podman containers</h2><h3 id=certbot-and-letsencrypt>Certbot and LetsEncrypt</h3><p>If you want valid SSL certificates (also required for the Companion app), you&rsquo;ll need your own domain name.
I advise using a registrar that supports the DNS challenge type for the certbot.
That way you don&rsquo;t need to expose any systems to request certificates.
You can even get a wildcard <code>*.yourdomain.tld</code> certificate so you don&rsquo;t even need to setup public domain names for your systems.
Another advantage is that you don&rsquo;t run into issues with a changing public IP for doing the web challenge, which requires setting up Dynamic DNS as a fix.</p><p>We&rsquo;ll create a file to store our secrets (keys for the challenge) and a directory for the certbot container to store its files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /srv/hass/certbot
</span></span><span style=display:flex><span>mkdir -p /srv/hass/secret
</span></span></code></pre></div><p><code>/srv/hass/secret/certbot-creds</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>dns_ovh_endpoint = ovh-eu
</span></span><span style=display:flex><span>dns_ovh_application_key = MDAwMDAwMDAwMDAw
</span></span><span style=display:flex><span>dns_ovh_application_secret = MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
</span></span><span style=display:flex><span>dns_ovh_consumer_key = MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAw
</span></span></code></pre></div><p>The exact config for Certbot will depend on your registrar and your own domain name.<br>In my case, I&rsquo;m using OVH.
I might add a blog post on how to get the necessary keys and tokens for the OVH DNS challenge.</p><p><code>~/.config/systemd/user/container-certbot.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>CertBot</span> <span style=color:#a6e22e>container</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>renew</span> <span style=color:#a6e22e>Let</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>Encrypt</span> <span style=color:#a6e22e>certificates</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-abnormal</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStartSec</span>=<span style=color:#ae81ff>10800</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>certbot-creds</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secret</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot-creds</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-a</span> <span style=color:#a6e22e>stdout</span> <span style=color:#a6e22e>-a</span> <span style=color:#a6e22e>stderr</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span> <span style=color:#a6e22e>certbot</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>etc</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>letsencrypt</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span>=<span style=color:#a6e22e>certbot-creds</span>,<span style=color:#a6e22e>mode</span>=<span style=color:#ae81ff>0400</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>dns-ovh</span> <span style=color:#a6e22e>-n</span> <span style=color:#a6e22e>renew</span> <span style=color:#a6e22e>--dns-ovh</span> <span style=color:#a6e22e>--dns-ovh-credentials</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>run</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secrets</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot-creds</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>cert</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>cert</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>live</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>fullchain</span>.<span style=color:#a6e22e>pem</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>key</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>key</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>certbot</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>live</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>privkey</span>.<span style=color:#a6e22e>pem</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>certbot-creds</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>oneshot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Notice how this service config uses <code>podman secret create</code> to pass our certbot credentials to the container.
It also removes this secret when the service is stopped.</p><p>Because the order of actions, specifically the pre and post, matters <code>Type=oneshot</code> is used here.</p><p><code>~/.config/systemd/user/container-certbot.timer</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Renews</span> <span style=color:#a6e22e>any</span> <span style=color:#a6e22e>certificates</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>need</span> <span style=color:#a6e22e>them</span> <span style=color:#a6e22e>renewed</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-certbot</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Timer</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Unit</span>=<span style=color:#a6e22e>container-certbot</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>OnCalendar</span>=<span style=color:#a6e22e>weekly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>timers</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Then enable the timer service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-certbot.timer
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/timers.target.wants/container-certbot.timer → /var/home/hass/.config/systemd/user/container-certbot.timer.
</span></span></code></pre></div><p>We do need to manually run the certbot tool once to get our certificates, which the renew service will keep up-to-date.
We&rsquo;ll also accept the Terms of Service of LetsEncrypt and we give them an email address to remind us of expiring certs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/bin/podman secret create certbot-creds /srv/hass/secret/certbot-creds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/bin/podman run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--cgroups<span style=color:#f92672>=</span>no-conmon <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--sdnotify<span style=color:#f92672>=</span>conmon <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-a stdout -a stderr <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--name certbot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--volume<span style=color:#f92672>=</span>/srv/hass/certbot:/etc/letsencrypt:z <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--secret<span style=color:#f92672>=</span>certbot-creds,mode<span style=color:#f92672>=</span><span style=color:#ae81ff>0400</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	docker.io/certbot/dns-ovh certonly <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-n --agree-tos --email certbot@example.org <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--dns-ovh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--dns-ovh-credentials /run/secrets/certbot-creds <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-d *.example.org
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Saving debug log to /var/log/letsencrypt/letsencrypt.log
</span></span><span style=display:flex><span>Account registered.
</span></span><span style=display:flex><span>Requesting a certificate <span style=color:#66d9ef>for</span> *.example.org
</span></span><span style=display:flex><span>Waiting <span style=color:#ae81ff>120</span> seconds <span style=color:#66d9ef>for</span> DNS changes to propagate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Successfully received certificate.
</span></span><span style=display:flex><span>Certificate is saved at: /etc/letsencrypt/live/example.org/fullchain.pem
</span></span><span style=display:flex><span>Key is saved at:         /etc/letsencrypt/live/example.org/privkey.pem
</span></span><span style=display:flex><span>This certificate expires on 2023-02-23.
</span></span><span style=display:flex><span>These files will be updated when the certificate renews.
</span></span><span style=display:flex><span>NEXT STEPS:
</span></span><span style=display:flex><span>- The certificate will need to be renewed before it expires. Certbot can automatically renew the certificate in the background, but you may need to take steps to enable that functionality. See https://certbot.org/renewal-setup <span style=color:#66d9ef>for</span> instructions.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span><span style=display:flex><span>If you like Certbot, please consider supporting our work by:
</span></span><span style=display:flex><span> * Donating to ISRG / Let<span style=color:#960050;background-color:#1e0010>&#39;</span>s Encrypt:   https://letsencrypt.org/donate
</span></span><span style=display:flex><span> * Donating to EFF:                    https://eff.org/donate-le
</span></span><span style=display:flex><span>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span></code></pre></div><p>Running the renew service once after this, will also ensure our certs are stored as Podman secrets.
These secrets will hold the SSL cert and private key and will be shared with the Nginx reverse proxy container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user start container-certbot.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>podman secret ls
</span></span><span style=display:flex><span>ID                         NAME              DRIVER      CREATED         UPDATED
</span></span><span style=display:flex><span>219a7a4790c900f313e0fd44f  example.org.key   file        <span style=color:#ae81ff>15</span> minutes ago  <span style=color:#ae81ff>15</span> minutes ago
</span></span><span style=display:flex><span>62ff3f2b637f31917f4fc0234  certbot-creds     file        <span style=color:#ae81ff>45</span> minutes ago  <span style=color:#ae81ff>45</span> minutes ago
</span></span><span style=display:flex><span>f8a3cafb519fc30df6e24b8b9  example.org.cert  file        <span style=color:#ae81ff>15</span> minutes ago  <span style=color:#ae81ff>15</span> minutes ago
</span></span></code></pre></div><h3 id=nginx-reverse-proxy>Nginx reverse proxy</h3><p>The Nginx reverse proxy will be the bridge between the internet and Home Assistant.</p><p>The <em>exposed</em> port of the Nginx container is deliberately set to a so-called non-privileged port (>1024) so we can keep our container rootless.
Using port forwarding on our router, we can open ports 80/tcp (HTTP) and 443/tcp (HTTPS) on the router while referring to ports 9080/tcp and 9443/tcp respectively on the container.
The proxy will then, based on the hostname, forward the connection to our Home Assistant instance using the IP of our podman&rsquo;s virtual network gateway <code>10.0.2.2</code> (see <code>proxy_pass</code>).</p><p>Let&rsquo;s start of with the config for the proxy.
Don&rsquo;t forget to update the following:</p><ul><li>Name of the SSL certificate and private key.</li><li><code>server_name</code> to match your Home Assistant hostname.<br>A <code>server_name</code> of <code>_</code> will match any domain name. We use this to forward HTTP to HTTPS but I&rsquo;d advise NOT to redirect any random hostname to your Home Assistant instance.</li></ul><p><code>/srv/hass/nginx/nginx.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>worker_processes</span> <span style=color:#960050;background-color:#1e0010>auto;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>error_log</span> <span style=color:#960050;background-color:#1e0010>/dev/stdout</span> <span style=color:#960050;background-color:#1e0010>info;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>pid</span> <span style=color:#960050;background-color:#1e0010>/run/nginx.pid;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>include</span> <span style=color:#960050;background-color:#1e0010>/usr/share/nginx/modules/mod-stream.conf;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>worker_connections</span> <span style=color:#960050;background-color:#1e0010>1024;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>map</span> <span style=color:#960050;background-color:#1e0010>$http_upgrade</span> <span style=color:#960050;background-color:#1e0010>$connection_upgrade</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>default</span> <span style=color:#960050;background-color:#1e0010>upgrade;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>&#39;&#39;</span> <span style=color:#960050;background-color:#1e0010>close;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_certificate</span> <span style=color:#e6db74>&#34;/run/secrets/example.org.cert&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>ssl_certificate_key</span> <span style=color:#e6db74>&#34;/run/secrets/example.org.key&#34;</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>9080;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>[::]:9080;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>server_name</span>  <span style=color:#960050;background-color:#1e0010>_;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>301</span> <span style=color:#960050;background-color:#1e0010>https:</span><span style=color:#75715e>//$host$request_uri;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>9443</span> <span style=color:#960050;background-color:#1e0010>ssl</span> <span style=color:#960050;background-color:#1e0010>http2;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>listen</span> <span style=color:#960050;background-color:#1e0010>[::]:9443</span> <span style=color:#960050;background-color:#1e0010>ssl</span> <span style=color:#960050;background-color:#1e0010>http2;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>server_name</span>  <span style=color:#960050;background-color:#1e0010>homeassistant.example.org;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>ssl_session_cache</span> <span style=color:#960050;background-color:#1e0010>shared:SSL:1m;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>ssl_session_timeout</span>  <span style=color:#960050;background-color:#1e0010>10m;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>ssl_ciphers</span> <span style=color:#960050;background-color:#1e0010>PROFILE=SYSTEM;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>ssl_prefer_server_ciphers</span> <span style=color:#960050;background-color:#1e0010>on;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>proxy_buffering</span> <span style=color:#960050;background-color:#1e0010>off;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>location</span> <span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_pass</span> <span style=color:#960050;background-color:#1e0010>http:</span><span style=color:#75715e>//10.0.2.2:8123;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Host</span> <span style=color:#960050;background-color:#1e0010>$host;</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_http_version</span> <span style=color:#960050;background-color:#1e0010>1.1;</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>X-Forwarded-For</span> <span style=color:#960050;background-color:#1e0010>$proxy_add_x_forwarded_for;</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Upgrade</span> <span style=color:#960050;background-color:#1e0010>$http_upgrade;</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>proxy_set_header</span> <span style=color:#960050;background-color:#1e0010>Connection</span> <span style=color:#960050;background-color:#1e0010>$connection_upgrade;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><p>Next is the config for the Nginx container.</p><p>Don&rsquo;t forget to modify the name of the secrets to match your config.</p><p><code>~/.config/systemd/user/container-nginx.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Nginx</span> <span style=color:#a6e22e>Reverse</span> <span style=color:#a6e22e>Proxy</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Documentation</span>=<span style=color:#a6e22e>man</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>podman-generate-systemd</span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>container-certbot</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-certbot</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span> <span style=color:#a6e22e>nginx</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--net</span> <span style=color:#a6e22e>slirp4netns</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>allow_host_loopback</span>=<span style=color:#66d9ef>true</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>9080</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>9080</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>9443</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>9443</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>conf</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>etc</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx</span>.<span style=color:#a6e22e>conf</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>cert</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span> <span style=color:#a6e22e>example</span>.<span style=color:#a6e22e>org</span>.<span style=color:#a6e22e>key</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>access</span>.<span style=color:#a6e22e>redhat</span>.<span style=color:#a6e22e>com</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>ubi8</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>nginx-120</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span> <span style=color:#a6e22e>nginx</span> <span style=color:#a6e22e>-g</span> <span style=color:#e6db74>&#34;daemon off;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>We can now launch the container, even though the redirect won&rsquo;t function yet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-nginx.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-nginx.service → /var/home/hass/.config/systemd/user/container-nginx.service.
</span></span></code></pre></div><h4 id=firewall-config>Firewall config</h4><p>Now set up your firewall/router to port forward ports 80/tcp and 443/tcp on your WAN (internet) side to ports 9080/tcp and 9443/tcp on your Fedora system respectively.</p><h3 id=home-assistant>Home Assistant</h3><p>This Home Assistant container has got a few <em>features</em>.</p><p>First of all, it <em>wants</em> (but doesn&rsquo;t <em>require</em>) the Z-Wave and Zigbee containers to be alive but won&rsquo;t shutdown if they&rsquo;re not.
You can comment these lines out if you won&rsquo;t have these running anyway.
I&rsquo;ll comment out the Z-Wave lines as I don&rsquo;t use it in my Home Assistant setup.</p><p>Secondly, there&rsquo;s a custom <a href=https://github.com/brianegge/home-assistant-sdnotify title=brianegge/home-assistant-sdnotify rel=external target=_blank>watchdog</a> service that will ensure the container restarts if Home Assistant ends up in a error state without exiting.
Since we first need to setup HA before we can install the watchdog, we&rsquo;ll comment out the its config for now.
I&rsquo;m keeping it in the config below for future reference.</p><p>Also, like with the Certbot container setup, we need to make sure the folder for the HA config exists.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /srv/hass/hass
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-homeassistant.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Home</span> <span style=color:#a6e22e>Assistant</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wants=container-zwave.service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>container-zigbee</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#75715e># After=container-zwave.service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-zigbee</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span> <span style=color:#a6e22e>WATCHDOG_USEC</span>=<span style=color:#ae81ff>5000000</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Note: this is using https://github.com/brianegge/home-assistant-sdnotify.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Once installed, uncomment the `WatchdogSec` line below</span>
</span></span><span style=display:flex><span><span style=color:#75715e># and change `--sdnotify=conmon` to `--sdnotify=container`.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># WatchdogSec=60</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>homeassistant</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--network</span>=<span style=color:#a6e22e>host</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>ghcr</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>home-assistant</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>home-assistant</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>stable</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Note that we tag the config folder with the shared content label (<code>:z</code>)..
This is because we will be sharing this folder with the <a href=/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/#hass-configurator title=HASS>HASS Configurator</a> container.
If you don&rsquo;t need or want to share the configuration folder, use the private content label (<code>:Z</code>) instead.</p><p>Now, again, we start the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-homeassistant.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-homeassistant.service → /var/home/hass/.config/systemd/user/container-homeassistant.service.
</span></span></code></pre></div><p>Give it some time and you should finally be able to see a glimpse of Home Assistant appearing at <code>http://ip.of.your.system:8123</code>.</p><figure class=center><img src=home_assistant-welcome.png alt="Home Assistant first setup screen"><figcaption class=center>It&rsquo;s alive!</figcaption></figure><h3 id=mosquitto-mqtt-broker>Mosquitto MQTT Broker</h3><p>We will need the Mosquitto MQTT broker when we&rsquo;re setting up the Zigbee2MQTT container.
But a lot of devices and applications can make use of MQTT as message protocol, so I always recomment installing Mosquitto.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /srv/hass/mosquitto/config
</span></span><span style=display:flex><span>mkdir /srv/hass/mosquitto/data
</span></span><span style=display:flex><span>mkdir /srv/hass/mosquitto/log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>touch /srv/hass/mosquitto/config/mqttuser
</span></span></code></pre></div><p>The Mosquitto config needs to be present before we start the container.
We can copy our config for Mosquitto from <a href=/blog/2022/09/home-assistant-container-part-4-mosquitto-docker-container/ title="Part 4: Mosquitto Docker Container">our Docker setup</a>.</p><p><code>/srv/hass/mosquitto/config/mosquitto.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span># Listen on port 1883
</span></span><span style=display:flex><span>listener 1883
</span></span><span style=display:flex><span>socket_domain ipv4
</span></span><span style=display:flex><span># save the in-memory database to disk
</span></span><span style=display:flex><span>persistence true
</span></span><span style=display:flex><span>persistence_location /mosquitto/data/
</span></span><span style=display:flex><span># Log to stderr and logfile
</span></span><span style=display:flex><span>log_dest stderr
</span></span><span style=display:flex><span>log_dest file /mosquitto/log/mosquitto.log
</span></span><span style=display:flex><span># Require authentication
</span></span><span style=display:flex><span>allow_anonymous false
</span></span><span style=display:flex><span>password_file /mosquitto/config/mqttuser
</span></span></code></pre></div><p>And yet another service file to autostart out container.</p><p><code>~/.config/systemd/user/container-mosquitto.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Mosquitto</span> <span style=color:#a6e22e>MQTT</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span> <span style=color:#a6e22e>mosquitto</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>1883</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>1883</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>log</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>mosquitto</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>log</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>eclipse-mosquitto</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>And start the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-mosquitto.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-mosquitto.service → /var/home/hass/.config/systemd/user/container-mosquitto.service.
</span></span></code></pre></div><p>We can now create accounts for the services we&rsquo;ll be using later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>podman exec -it mosquitto mosquitto_passwd -c /mosquitto/config/mqttuser mqtt_ha
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span>Reenter password:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Drop the -c this time or it will wipe out the previous account!</span>
</span></span><span style=display:flex><span>podman exec -it mosquitto mosquitto_passwd /mosquitto/config/mqttuser mqtt_z2m
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span>Reenter password:
</span></span></code></pre></div><p>You can see these being added:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cat /srv/hass/mosquitto/config/mqttuser
</span></span><span style=display:flex><span>mqtt_ha:$7$101$Dh*****rM$3Y********************<span style=color:#f92672>==</span>
</span></span><span style=display:flex><span>mqtt_z2m:$7$101$3t*****L7$Ir********************<span style=color:#f92672>==</span>
</span></span></code></pre></div><h3 id=zigbee2mqtt>Zigbee2MQTT</h3><p>You only need this container if you&rsquo;re using Z2M as Zigbee coordinator.
There&rsquo;s also Zigbee Home Automation (ZHA) that&rsquo;s built-in in Home Assistant and deCONZ by dresden elektronik.</p><h4 id=container-permissions-and-selinux>Container permissions and SELinux</h4><p>Since we&rsquo;re using a Zigbee controller connected over USB, we need to provide permissions to the container to do so,
otherwise SELinux will block the container from doing so.</p><p>Here&rsquo;re I&rsquo;ll also follow the setup by Matthew as I don&rsquo;t have experience with SELinux.
Their setup involves using a custom SELinux module that allows containers to access USB serial devices.</p><p>We&rsquo;ll need sudo rights, so you may need to switch back to our sudo user <code>core</code> for these next steps.</p><p><code>~/container-usbtty.te</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>module</span> <span style=color:#960050;background-color:#1e0010>container-usbtty</span> <span style=color:#ae81ff>1.0</span><span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>require</span> {
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>type</span> <span style=color:#960050;background-color:#1e0010>container_t;</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>type</span> <span style=color:#960050;background-color:#1e0010>usbtty_device_t;</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>class</span> <span style=color:#960050;background-color:#1e0010>chr_file</span> <span style=color:#960050;background-color:#1e0010>{</span> <span style=color:#960050;background-color:#1e0010>getattr</span> <span style=color:#960050;background-color:#1e0010>ioctl</span> <span style=color:#960050;background-color:#1e0010>lock</span> <span style=color:#960050;background-color:#1e0010>open</span> <span style=color:#960050;background-color:#1e0010>read</span> <span style=color:#960050;background-color:#1e0010>write</span> }<span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#=============</span> <span style=color:#960050;background-color:#1e0010>container_t</span> <span style=color:#960050;background-color:#1e0010>==============</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>allow</span> <span style=color:#960050;background-color:#1e0010>container_t</span> <span style=color:#960050;background-color:#1e0010>usbtty_device_t:chr_file</span> { <span style=color:#960050;background-color:#1e0010>getattr</span> <span style=color:#960050;background-color:#1e0010>ioctl</span> <span style=color:#960050;background-color:#1e0010>lock</span> <span style=color:#960050;background-color:#1e0010>open</span> <span style=color:#960050;background-color:#1e0010>read</span> <span style=color:#960050;background-color:#1e0010>write</span> }<span style=color:#960050;background-color:#1e0010>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>checkmodule -M -m -o container-usbtty.mod container-usbtty.te
</span></span><span style=display:flex><span>semodule_package -o container-usbtty.pp -m container-usbtty.mod
</span></span><span style=display:flex><span>sudo semodule -i container-usbtty.pp
</span></span></code></pre></div><p>Running into issues with permissions? Check the <a href=/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/#troubleshooting title=Troubleshooting>Troubleshooting</a> section.</p><h4 id=config>Config</h4><p>As with the Mosquitto container, we need to provide a config for the Zigbee2MQTT application before starting it up.
And again we can have a look at our <a href=/blog/2022/10/home-assistant-container-part-10-zigbee2mqtt/ title="Part 10: Zigbee2MQTT">Docker setup</a> for this.</p><p>Since Nginx is using port 8080, which is the default port for the Zigbee2MQTT dashboard, we tell Z2M to use a different port.</p><p><code>/srv/hass/zigbee/configuration.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Adapter settings</span>
</span></span><span style=display:flex><span><span style=color:#f92672>serial</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>/dev/zigbee</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># MQTT</span>
</span></span><span style=display:flex><span><span style=color:#f92672>mqtt</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>base_topic</span>: <span style=color:#ae81ff>zigbee2mqtt</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>server</span>: <span style=color:#e6db74>&#39;!secret server&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>user</span>: <span style=color:#e6db74>&#39;!secret user&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#39;!secret password&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>client_id</span>: <span style=color:#ae81ff>zigbee</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Zigbee network</span>
</span></span><span style=display:flex><span><span style=color:#f92672>permit_join</span>: <span style=color:#66d9ef>false</span> <span style=color:#75715e># Do not allow random devices to connect automatically</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Webserver</span>
</span></span><span style=display:flex><span><span style=color:#f92672>frontend</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#39;http://10.0.2.2:8081&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Devices and groups</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Extract config to separate files</span>
</span></span><span style=display:flex><span><span style=color:#f92672>devices</span>: <span style=color:#ae81ff>devices.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>groups</span>: <span style=color:#ae81ff>groups.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Home Assistant integration</span>
</span></span><span style=display:flex><span><span style=color:#f92672>homeassistant</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>advanced</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Zigbee network - auto-generate new keys</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pan_id</span>: <span style=color:#ae81ff>GENERATE</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>network_key</span>: <span style=color:#ae81ff>GENERATE</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Zigbee network - set channel to avoid interference with 2.4GHz WiFi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>channel</span>: <span style=color:#ae81ff>24</span>
</span></span></code></pre></div><p>I haven&rsquo;t found a method to store the secrets mentioned in the config above as a Podman secret.
The issue is that secrets are mounted at <code>/run/secrets/secretname</code> and Z2M expects the file to be named <code>secret.yaml</code> and be stored in the same folder as <code>configuration.yaml</code>.
So for the moment, I store the secrets file next to the configuration file in the config folder.</p><p>I hope a change to <a href=https://github.com/Koenkk/zigbee2mqtt/issues/15226 title="Github issue @ Z2M - [Feature request]: Allow defining location of secret.yaml #15226" rel=external target=_blank>Zigbee2MQTT</a> or <a href=https://github.com/containers/podman/issues/16649 title="Github issue @ podman - [FEATURE REQUEST] Mount secret at different location #16649" rel=external target=_blank>Podman</a> can help fix this.</p><p><code>/srv/hass/zigbee/secret.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server</span>: <span style=color:#e6db74>&#39;mqtt://10.0.2.2&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>user</span>: <span style=color:#e6db74>&#39;mqtt_z2m&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>password</span>: <span style=color:#e6db74>&#39;MySuperSecretPa$$w0rd&#39;</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to change the <code>device</code> path in the config below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l /dev/serial/by-id/
</span></span><span style=display:flex><span>usb-ITead_Sonoff_Zigbee_3.0_USB_Dongle_Plus_eexxx52-if00-port0 -&gt; ../../ttyUSB0
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-zigbee.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Zigbee2MQTT</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-mosquitto</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-mosquitto</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>z2m-creds</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secret</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>z2m-secrets</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>zigbee</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--network</span>=<span style=color:#a6e22e>slirp4netns</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>allow_host_loopback</span>=<span style=color:#66d9ef>true</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--device</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>dev</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>serial</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>by-id</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usb-ITead_Sonoff_Zigbee_3</span>.<span style=color:#ae81ff>0</span><span style=color:#a6e22e>_USB_Dongle_Plus_ee6789cf0260ec11ba5a345f25bfaa52-if00-port0</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>dev</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zigbee</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>rw</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zigbee</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>app</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span>=<span style=color:#a6e22e>z2m-creds</span>,<span style=color:#a6e22e>target</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>app</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>yaml</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>8081</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8081</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>koenkk</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zigbee2mqtt</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>z2m-creds</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>oneshot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>We pass our credentials via the <code>--secret</code> and give it a path, and tell the service it needs to wait for the Mosquitto service to have started.</p><p>Then again, start the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-zigbee.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-zigbee.service → /var/home/hass/.config/systemd/user/container-zigbee.service.
</span></span></code></pre></div><p>Don&rsquo;t forget to check out the <a href=/blog/2022/10/home-assistant-container-part-10-zigbee2mqtt/ title="Part 10: Zigbee2MQTT">previous blog post on Zigbee2MQTT</a> for the automations and dashboard config to make the most out of Z2M.</p><h3 id=zwave2mqtt>ZWave2MQTT</h3><p>I&rsquo;m copying this from Matthew&rsquo;s forum post as I don&rsquo;t use Z-Wave myself.</p><p>See also the notes on <em>Container permissions and SELinux</em> in the Zigbee2MQTT section.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /srv/hass/zwave
</span></span></code></pre></div><p><code>~/.config/systemd/user/container-zwave.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>ZWave2MQTT</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>zwave</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--device</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>dev</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>serial</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>by-id</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usb-Silicon_Labs_Zooz_ZST10</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#a6e22e>u00A0700_Z-Wave_Stick_0001-if00-port0</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>dev</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zwave</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>rw</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zwave</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>app</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>store</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>8091</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8091</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>3000</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>3000</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zwavejs</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>zwavejs2mqtt</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Start the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-zigbee.service
</span></span></code></pre></div><h3 id=esphome>ESPHome</h3><p>Here&rsquo;re we&rsquo;re leaving Matthew&rsquo;s forum post as he didn&rsquo;t discuss setting up ESPHome.
Luckily, we already did the heavy lifting <a href=/blog/2022/09/home-assistant-container-part-9-esphome/ title="Part 9: ESPHome">before</a>.</p><p><code>~/.config/systemd/user/container-esphome.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>ESPHome</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>esphome</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--network</span>=<span style=color:#a6e22e>host</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Note that we tag the config folder with the shared content label (<code>:z</code>)..
This is because we will be sharing this folder with the <a href=/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/#hass-configurator title=HASS>HASS Configurator</a> container.
If you don&rsquo;t need or want to share the configuration folder, use the private content label (<code>:Z</code>) instead.</p><p>Create the directory for the esphome config and enable the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /srv/hass/esphome
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl --user enable --now container-esphome.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-esphome.service → /var/home/hass/.config/systemd/user/container-esphome.service.
</span></span></code></pre></div><p>Now you can access the ESPHome Dashboard at <code>http://&lt;ip.of.your.system>:6052</code>.</p><p>In my case, it even discovered (and allowed me to adopt) a bluetooth proxy I still had on my network from before my system crash.</p><figure class=center><img src=esphome_dashboard.png alt="ESPHome Dashboard"><figcaption class=center>ESPHome Dashboard</figcaption></figure><h3 id=hass-configurator>HASS Configurator</h3><p>Editing configuration files from within the browser is a lot more user friendly than having to SSH into our system each time, so lets set up <a href=/blog/2022/09/home-assistant-container-part-6-editing-configuration.yaml-from-within-home-assistant/ title="Part 6: Editing configuration.yaml from within Home Assistant">HASS Configurator</a> again.</p><p><code>~/.config/systemd/user/container-hassconf.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>HASSConfigurator</span> <span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-homeassistant</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-homeassistant</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span>=<span style=color:#a6e22e>hassconf</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hassconf</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>Z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>hass-config</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>hass-config</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>esphome</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>3218</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>3218</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>causticlab</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass-configurator-docker</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p>Note that we&rsquo;re mounting the config folders from our Home Assistant and ESPHome containers.
Make sure you marked these volumes as shared (<code>:z</code>) in their respective configurations.</p><p>We also want set our &ldquo;working directory&rdquo; in HASS Configurator to our Home Assistant config folder.</p><p><code>/srv/hass/hassconf/settings.conf</code> (you will need to create the directory first)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;BASEPATH&#34;</span>: <span style=color:#e6db74>&#34;/hass-config&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;ENFORCE_BASEPATH&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span> <span style=color:#f92672>&#34;DIRSFIRST&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Enable the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-hassconf.service
</span></span><span style=display:flex><span>Created symlink /var/home/hass/.config/systemd/user/default.target.wants/container-hassconf.service → /var/home/hass/.config/systemd/user/container-hassconf.service.
</span></span></code></pre></div><h2 id=sidebar>Sidebar</h2><p>Time to repeat ourselves <a href=/blog/2022/09/home-assistant-container-part-3-mariadb-and-influxdb/#manage-portainer-from-within-home-assistant title="Home Assistant sidebar">yet again</a> and setup our sidebar.</p><p><strong>Note:</strong> This has changed since <a href=https://www.home-assistant.io/blog/2024/04/03/release-20244/#webpage-dashboard title="2024.4 release notes - webpage dashboard" rel=external target=_blank>Home Assistant 2024.4</a>.
You can now use a <a href=https://www.home-assistant.io/dashboards/dashboards/#webpage-dashboard title="Webpage dashboard" rel=external target=_blank>Webpage Dashboard</a> to embed a webpage in your dashboard.</p><p><del>The config below needs to end up in the <code>configuration.yaml</code> inside the Home Assistant config folder (<code>/srv/hass/hass</code>).</del>
<del>You can do this through our freshly launched HASS Configurator or over SSH.</del></p><p><code>/srv/hass/hass/configuration.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Outdated, use web dashboard</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>panel_iframe</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>configurator</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Configurator</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>icon</span>: <span style=color:#ae81ff>mdi:wrench</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://&lt;ip.of.your.system&gt;:3218</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>require_admin</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>esphome</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>title</span>: <span style=color:#ae81ff>ESPHome</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>icon</span>: <span style=color:#ae81ff>mdi:chip</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://&lt;ip.of.your.system&gt;:6052</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>require_admin</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>zigbee2mqtt</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Zigbee2MQTT</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>icon</span>: <span style=color:#ae81ff>mdi:zigbee</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://&lt;ip.of.your.system&gt;:8081</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>require_admin</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Note that you need to use the address you would use to visit these containers directly from your desktop/laptop since this uses iframes.
You can&rsquo;t use the podman-internal addresses (like <code>10.0.2.2</code>).
However, you could setup nginx as a reverse proxy for these as well, even give them a(n internal) domain name and a SSL certificate, and then reference that address in this config.</p><p>Confirm using the DevTools that we didn&rsquo;t make a typo and restart Home Assistant to apply the config.</p><figure class=center><img src=devtools_restart.png alt="DevTools check configuration"><figcaption class=center>No errors</figcaption></figure><h2 id=backups>Backups</h2><p>The process for backing your config is fairly easy as everything is located at <code>/srv/hass</code> and <code>~/.config/systemd/user/container-*.service</code>.
You can setup a cronjob doing an <a href=https://linuxconfig.org/how-to-create-incremental-backups-using-rsync-on-linux title="How to create incremental backups using rsync on Linux" rel=external target=_blank>rsync backup</a> that archives and copies these files to a NAS, for example.
you&rsquo;ll need to do this as a root user so you don&rsquo;t run into permission issues with the container volumes.</p><blockquote><p>There is however one notable exception: if you want to avoid the possibility of backing up <code>home-assistant_v2.db</code> when it&rsquo;s in a not-settled state (possibly leading to corruption and losing your state history), you should periodically run something like</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;vacuum into &#34;/src/hass/backup/home-assistant_v2-bak.db&#34;&#39;</span> | sqlite3 /srv/hass/hass/home-assistant_v2.db
</span></span></code></pre></div><h3 id=backup-to-nas-over-nfs>Backup to NAS over NFS</h3><p>Below are my configurations for backing up my Podman containers to my NAS over NFS.</p><h4 id=mount-backup-folder>Mount backup folder</h4><p>Setup a share on your NAS and grant NFS permissions to the IP of your Podman system.</p><p>Then create the following systemd mount config.
The filename must match your local mount path (<code>Where</code>) using hyphens instead of slashes.</p><p><strong>Note</strong> <code>/mnt</code> is symlinked to <code>/var/mnt</code> on my Fedora CoreOS system and I needed to uses that path.
Otherwise I got symbolic link errors.</p><p><code>/etc/systemd/system/var-mnt-backup.mount</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>HomeAssistant</span> <span style=color:#a6e22e>Backup</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Mount</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>What</span>=<span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>of</span>.<span style=color:#a6e22e>my</span>.<span style=color:#a6e22e>nas</span><span style=color:#960050;background-color:#1e0010>&gt;:/</span><span style=color:#a6e22e>volume1</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>backup</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Where</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>var</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>mnt</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>backup</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>nfs</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Options</span>=<span style=color:#a6e22e>_netdev</span>,<span style=color:#a6e22e>auto</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>multi-user</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl start var-mnt-backup.mount
</span></span><span style=display:flex><span>sudo systemctl enable var-mnt-backup.mount
</span></span><span style=display:flex><span>Created symlink /etc/systemd/system/multi-user.target.wants/var-mnt-backup.mount → /etc/systemd/system/var-mnt-backup.mount.
</span></span></code></pre></div><h4 id=backup-script>Backup script</h4><p>The following script will use <code>rsync</code> to create an incremental backup.
I also added the <code>vacuum</code> command mentioned above to &ldquo;copy&rdquo; the database. That&rsquo;s why I&rsquo;m ignoring the database in the rsync command.</p><p><code>/var/home/core/backup-podman.sh</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># A script to perform incremental backups using rsync</span>
</span></span><span style=display:flex><span>set -o errexit
</span></span><span style=display:flex><span>set -o nounset
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>readonly SOURCE_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/srv/hass&#34;</span>
</span></span><span style=display:flex><span>readonly BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/mnt/backup&#34;</span>
</span></span><span style=display:flex><span>readonly DATETIME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y-%m-%d_%H:%M&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>readonly BACKUP_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>DATETIME<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>readonly LATEST_LINK<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/latest&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;----- BACKUP STARTED -----&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rsync -av --delete <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SOURCE_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --link-dest <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;home-assistant_v2.db&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.cache&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;log&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;*.log&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;.esphome&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Recreating link&#34;</span>
</span></span><span style=display:flex><span>rm -rf <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>ln -rs <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>BACKUP_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>LATEST_LINK<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Copy database</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Copying database&#34;</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;vacuum into \&#34;</span><span style=color:#e6db74>${</span>BACKUP_PATH<span style=color:#e6db74>}</span><span style=color:#e6db74>/hass/home-assistant_v2.db\&#34;&#34;</span> | sqlite3 <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>SOURCE_DIR<span style=color:#e6db74>}</span><span style=color:#e6db74>/hass/home-assistant_v2.db&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;----- BACKUP DONE -----&#34;</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to make this script executable and test it out.
Run as root so you don&rsquo;t get permission errors.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>chmod u+x /var/home/core/backup-podman.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo /var/home/core/backup-podman.sh
</span></span></code></pre></div><h4 id=crontab>Crontab</h4><p>Now we&rsquo;ll create a cronjob that will automatically call the back-up script on a weekly basis.
This will ensure we have weekly back-ups of our config.</p><p>But first we need to install the <code>cronie</code> package which will provide us with <code>cron</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo rpm-ostree install cronie
</span></span><span style=display:flex><span>sudo rpm-ostree apply-live
</span></span></code></pre></div><p>Then we can write our cronjob.</p><p><code>/etc/crontab</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>SHELL=/bin/bash
</span></span><span style=display:flex><span>PATH=/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span style=display:flex><span>MAILTO=core
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># For details see man 4 crontabs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Example of job definition:
</span></span><span style=display:flex><span># .---------------- minute (0 - 59)
</span></span><span style=display:flex><span># | .------------- hour (0 - 23)
</span></span><span style=display:flex><span># | | .---------- day of month (1 - 31)
</span></span><span style=display:flex><span># | | | .------- month (1 - 12) OR jan,feb,mar,apr ...
</span></span><span style=display:flex><span># | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
</span></span><span style=display:flex><span># | | | | |
</span></span><span style=display:flex><span># * * * * * user-name command to be executed
</span></span><span style=display:flex><span>0 22 * * 6 root /var/home/core/backup-podman.sh &gt; /dev/null
</span></span></code></pre></div><p>This will execute the <code>backup-podman.sh</code> script as root every Saturday at 22:00 (before the auto-update reboot window).
<code>stdout</code> output will be ignored, only error output (<code>stderr</code>) will be mailed to the <code>core</code> user.</p><h2 id=troubleshooting>Troubleshooting</h2><h3 id=i-made-changes-to-a-service-file-after-starting-a-service>I made changes to a service file after starting a service</h3><p>Run <code>systemctl --user daemon-reload</code> to load your changes.
Then run <code>systemctl --user restart &lt;SERVICE>.service</code> to restart the service using the new config.</p><h3 id=i-cant-modify-container-files>I can&rsquo;t modify container files</h3><p>Containers will be running using their own user inside the container.
The UserID of that user may not match the UserID of your user.
Rootless containers don&rsquo;t map the user account to e.g. root.</p><p>So if you want to change a file in one of the container&rsquo;s volumes and can&rsquo;t or don&rsquo;t want to do it via the terminal/console of the container,
you&rsquo;ll need to SSH into your sudo user (e.g. <code>core</code>) and use root privileges to change the files.
If you&rsquo;re creating new files using the root account (via sudo), their permissions will be mapped to root.
So don&rsquo;t forget to <code>chown</code> these files to the correct userID (check the permissions of the folder or other files within the folder using <code>ls -l</code>).</p><h3 id=error-short-name-resolution-enforced-but-cannot-prompt-without-a-tty>Error: short-name resolution enforced but cannot prompt without a TTY</h3><p>Podman doesn&rsquo;t have a default container registry configured.
So if you use the short name of a container, like <code>eclipse/mosquitto</code>, it doesn&rsquo;t know which registry you want to pull it from.</p><p>Either use the full link to the container, such as <code>docker.io/eclipse/mosquitto</code>, or add your preferred registry/registries to your Podman <code>registries.conf</code>.
The user config is located at <code>$HOME/.config/containers/registries.conf</code> and the system config is located at <code>/etc/containers/registries.conf</code>.</p><p>Edit or add the following line to suit your needs:<br><code>unqualified-search-registries = ['docker.io', 'registry.fedoraproject.org', 'registry.access.redhat.com', 'registry.centos.org', 'quay.io', 'ghcr.io']</code></p><h3 id=checkmodule-command-not-found>checkmodule: command not found</h3><p>Your linux installation may not come with this tool installed.
To get the <code>checkmodule</code> tool, install the <code>checkpolicy</code> package using your distro&rsquo;s package manager.</p><p>Fedora CoreOS seems to be built a bit different and doesn&rsquo;t have the <code>yum</code> or <code>dnf</code> package managers installed.
Instead it uses <code>RPM-OStree</code>.
Package installations are more like a pull request in the system config where you need to get the new code and apply it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ rpm-ostree install checkpolicy
</span></span><span style=display:flex><span><span style=color:#f92672>====</span> AUTHENTICATING FOR org.projectatomic.rpmostree1.install-uninstall-packages <span style=color:#f92672>====</span>
</span></span><span style=display:flex><span>Authentication is required to install and remove software
</span></span><span style=display:flex><span>Authenticating as: CoreOS Admin <span style=color:#f92672>(</span>core<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Password:
</span></span><span style=display:flex><span><span style=color:#f92672>====</span> AUTHENTICATION COMPLETE <span style=color:#f92672>====</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>Added:
</span></span><span style=display:flex><span>  checkpolicy-3.3-2.fc36.x86_64
</span></span><span style=display:flex><span>Changes queued <span style=color:#66d9ef>for</span> next boot. Run <span style=color:#e6db74>&#34;systemctl reboot&#34;</span> to start a reboot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ sudo rpm-ostree apply-live
</span></span><span style=display:flex><span>Computing /etc diff to preserve... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Updating /usr... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Updating /etc... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Running systemd-tmpfiles <span style=color:#66d9ef>for</span> /run and /var... <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Added:
</span></span><span style=display:flex><span>  checkpolicy-3.3-2.fc36.x86_64
</span></span><span style=display:flex><span>Successfully updated running filesystem tree.
</span></span></code></pre></div><h3 id=selinux-permission-issues-with-device-mounts>SELinux permission issues with device mounts</h3><p>If you run into permissions issues when you&rsquo;re trying to mount devices like a Zigbee controller, there are 2 solutions which may fix the issue.
Note that these open up the permissions on your system and thus will reduce the security of your system somewhat.</p><ol><li><p>Allow all containers to access all devices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo semanage boolean -m --on container_use_devices
</span></span></code></pre></div></li><li><p>The drastic solution of disabling SELinux:<br>To disable SELinux intil the next reboot, execute the following command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo setenforce <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Permanently disabeling SELinux can be done by modifying <code>/etc/selinux/config</code> and changing <code>SELINUX=enforcing</code> to <code>SELINUX=permissive</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sed -i <span style=color:#e6db74>&#39;s/=enforcing/=permissive/&#39;</span> /etc/selinux/config
</span></span></code></pre></div></li></ol><h2 id=changelog>Changelog</h2><ul><li><strong>2022-12-03</strong><ul><li>Added explanation on permanently disabeling SELinux</li></ul></li><li><strong>2023-04-05</strong><ul><li>Fix <code>sudo semodule -i container-usbtty.pp</code> instead of <code>container-usbtty.pp</code></li></ul></li><li><strong>2023-04-17</strong><ul><li>Remove <code>certbot-creds</code> in <code>ExecStopPost</code> otherwise you get errors/warning about a secret already existing</li></ul></li><li><strong>2024-09-05</strong><ul><li>Reference Webpage dashboard replacing <code>iframe_panel</code> since 2024.04</li></ul></li></ul></main><hr><footer><div class=footer><p>This is a post in the <span style=font-weight:700><a href=https://sequr.be/series/ha-container>HA Container</a></span> series.<br>Other posts in this series:<ul class=series><li>Feb 12, 2024 -
<a href=/blog/2024/02/home-assistant-container-part-13-vs-code-code-server/>Home Assistant Container Part 13: VS Code code-server</a></li><li>Dec 2, 2022 -
Home Assistant Container Part 12: Migrating to Podman</li><li>Nov 25, 2022 -
<a href=/blog/2022/11/home-assistant-container-part-11-bluetooth-support/>Home Assistant Container Part 11: Bluetooth support</a></li><li>Oct 4, 2022 -
<a href=/blog/2022/10/home-assistant-container-part-10-zigbee2mqtt/>Home Assistant Container Part 10: Zigbee2MQTT</a></li><li>Sep 15, 2022 -
<a href=/blog/2022/09/home-assistant-container-part-9-esphome/>Home Assistant Container Part 9: ESPHome</a></li><li>Sep 11, 2022 -
<a href=/blog/2022/09/home-assistant-container-part-8-update-home-assistant-container/>Home Assistant Container Part 8: Update Home Assistant Container</a></li><li>Sep 9, 2022 -
<a href=/blog/2022/09/home-assistant-container-part-7-backing-up-home-assistant-container/>Home Assistant Container Part 7: Backing up Home Assistant Container</a></li><li>Sep 8, 2022 -
<a href=/blog/2022/09/home-assistant-container-part-6-editing-configuration.yaml-from-within-home-assistant/>Home Assistant Container Part 6: Editing configuration.yaml from within Home Assistant</a></li><li>Sep 7, 2022 -
<a href=/blog/2022/09/home-assistant-container-part-5-node-red/>Home Assistant Container Part 5: Node-RED</a></li><li>Sep 5, 2022 -
<a href=/blog/2022/09/home-assistant-container-part-4-mosquitto-docker-container/>Home Assistant Container Part 4: Mosquitto Docker Container</a></li><li>Sep 3, 2022 -
<a href=/blog/2022/09/home-assistant-container-part-3-mariadb-and-influxdb/>Home Assistant Container Part 3: MariaDB and InfluxDB</a></li><li>Sep 2, 2022 -
<a href=/blog/2022/09/home-assistant-container-part-2-home-assistant-container/>Home Assistant Container Part 2: Home Assistant Container</a></li><li>Aug 31, 2022 -
<a href=/blog/2022/08/home-assistant-container-part-1-install-debian-docker-and-portainer/>Home Assistant Container Part 1: Install Debian, Docker and Portainer</a></li></ul></p><p><div class=previous-post><a href="https://sequr.be/blog/2022/11/home-assistant-container-part-11-bluetooth-support/?ref=footer"><span style=font-weight:700>« Previous</span><br>Home Assistant Container Part 11: Bluetooth...</a><div class=next-post><a href="https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/?ref=footer"><span style=font-weight:700>Next »</span><br>Flashing NSPanel with Tasmota and NSPanel Lovelace...</a></div></p></div></footer></article></section><aside class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#fedora-core-os>Fedora Core OS</a><ul><li><a href=#preparing-live-usb>Preparing Live USB</a></li><li><a href=#preparing-ignition-configuration>Preparing Ignition configuration</a></li><li><a href=#installing-fedora-coreos>Installing Fedora CoreOS</a></li><li><a href=#finishing-touches>Finishing touches</a><ul><li><a href=#linger>Linger</a></li><li><a href=#directory-structure>Directory structure</a></li></ul></li></ul></li><li><a href=#podman-setup>Podman setup</a><ul><li><a href=#podman-autoupdate>Podman Autoupdate</a></li></ul></li><li><a href=#podman-containers>Podman containers</a><ul><li><a href=#certbot-and-letsencrypt>Certbot and LetsEncrypt</a></li><li><a href=#nginx-reverse-proxy>Nginx reverse proxy</a><ul><li><a href=#firewall-config>Firewall config</a></li></ul></li><li><a href=#home-assistant>Home Assistant</a></li><li><a href=#mosquitto-mqtt-broker>Mosquitto MQTT Broker</a></li><li><a href=#zigbee2mqtt>Zigbee2MQTT</a><ul><li><a href=#container-permissions-and-selinux>Container permissions and SELinux</a></li><li><a href=#config>Config</a></li></ul></li><li><a href=#zwave2mqtt>ZWave2MQTT</a></li><li><a href=#esphome>ESPHome</a></li><li><a href=#hass-configurator>HASS Configurator</a></li></ul></li><li><a href=#sidebar>Sidebar</a></li><li><a href=#backups>Backups</a><ul><li><a href=#backup-to-nas-over-nfs>Backup to NAS over NFS</a><ul><li><a href=#mount-backup-folder>Mount backup folder</a></li><li><a href=#backup-script>Backup script</a></li><li><a href=#crontab>Crontab</a></li></ul></li></ul></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#i-made-changes-to-a-service-file-after-starting-a-service>I made changes to a service file after starting a service</a></li><li><a href=#i-cant-modify-container-files>I can&rsquo;t modify container files</a></li><li><a href=#error-short-name-resolution-enforced-but-cannot-prompt-without-a-tty>Error: short-name resolution enforced but cannot prompt without a TTY</a></li><li><a href=#checkmodule-command-not-found>checkmodule: command not found</a></li><li><a href=#selinux-permission-issues-with-device-mounts>SELinux permission issues with device mounts</a></li></ul></li><li><a href=#changelog>Changelog</a></li></ul></nav></div></aside></div></body></html>