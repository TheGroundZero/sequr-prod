<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-US lang=en-US><head><title itemprop=name>Flashing NSPanel with Tasmota and NSPanel Lovelace UI :: Sequr</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="noodp, noydir"><meta name=googlebot content="noodp, noydir"><meta name=url content="https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/" itemprop=url><link rel=icon href=/favicon.ico><meta itemprop=name content="Flashing NSPanel with Tasmota and NSPanel Lovelace UI"><meta itemprop=description content="We’re flashing Tasmota on a Sonoff NSPanel and installing NSPanel Lovelace UI to easily create our views"><meta itemprop=datePublished content="2023-01-14T00:00:00+01:00"><meta itemprop=dateModified content="2023-01-14T00:00:00+01:00"><meta itemprop=wordCount content="2411"><meta itemprop=image content="https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,NSPanel,Tasmota,Lovelace,Sonoff"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/cover.png"><meta name=twitter:title content="Flashing NSPanel with Tasmota and NSPanel Lovelace UI"><meta name=twitter:description content="We’re flashing Tasmota on a Sonoff NSPanel and installing NSPanel Lovelace UI to easily create our views"><meta property="og:url" content="https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/"><meta property="og:site_name" content="Sequr"><meta property="og:title" content="Flashing NSPanel with Tasmota and NSPanel Lovelace UI"><meta property="og:description" content="We’re flashing Tasmota on a Sonoff NSPanel and installing NSPanel Lovelace UI to easily create our views"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-01-14T00:00:00+01:00"><meta property="article:modified_time" content="2023-01-14T00:00:00+01:00"><meta property="article:tag" content="Home Automation"><meta property="article:tag" content="Home Assistant"><meta property="article:tag" content="NSPanel"><meta property="article:tag" content="Tasmota"><meta property="article:tag" content="Lovelace"><meta property="article:tag" content="Sonoff"><meta property="og:image" content="https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/cover.png"><meta name=description content="We&rsquo;re flashing Tasmota on a Sonoff NSPanel and installing NSPanel Lovelace UI to easily create our views"><meta property="og:updated_time" content="2023-01-14T00:00:00+01:00"><link rel=sitemap type=application/xml title=Sitemap href=https://sequr.be/sitemap.xml><meta name=apple-mobile-web-app-title content="Flashing NSPanel with Tasmota and NSPanel Lovelace UI"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><link rel=webmention href=https://webmention.io/sequr.be/webmention><link rel=stylesheet href=/css/bundle.min.308a714c50df5143bc08878001fede0511b3f9022c4c129848a3643270ab2f10.css integrity="sha256-MIpxTFDfUUO8CIeAAf7eBRGz+QIsTBKYSKNkMnCrLxA=" crossorigin=anonymous><script defer type=text/javascript src=/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js integrity="sha256-FFRTJhp3VfUEKoVMQhNQHSFaj740wI0YHED4A/ExXnQ=" crossorigin=anonymous></script></head><body class=dark-theme><div class=wrapper><aside class="sidebar h-card background-image"><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class="sidebar-about hcard"><h1 class=brand><a href=https://sequr.be/><img src=/logo.png class="u-logo u-photo" alt="Sequr brand image">
</a><a href=https://sequr.be/ class="u-url p-org"><h1>Sequr</h1></a></h1><p class="lead p-note">Writeups and random stuff about infosec and life</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/ title=About>About</a></li><li class=heading><a href=/blog/ title=Blog>Blog</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=/blog/2025/02/flashing-the-sonoff-powr3-with-tasmota/ title="Flashing the Sonoff POWR3 with Tasmota" hreflang=en>Tasmota on Sonoff POWR3</a></li><li class=bullet><a href=/blog/2025/01/sending-my-first-webmention-from-scratch/ title="Sending my first webmention from scratch" hreflang=en>My first Webmention</a></li><li class=bullet><a href=/blog/2025/01/bridging-this-blog-with-the-fediverse/ title="Bridging this blog with the Fediverse" hreflang=en>Briding with the Fediverse</a></li><li class=heading><a href=/shoppinglist/ title=Shopping>Shopping</a></li><li class=heading><a href=/privacy/ title=Privacy>Privacy</a></li></ul></nav><a target=_blank class=social title="Atom Feed" href=/atom.xml><svg width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><a href=https://bsky.app/profile/sequr.be target=_blank class="u-url social" rel="external noopener me" title=Bluesky><svg width="1.2em" height="1.2em" viewBox="0 0 568 501"><path fill="currentcolor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873c25.719-53.192 95.759-152.3204 160.879-201.2093C491.866-1.61183 568-28.9064 568 57.9464 568 75.2916 558.055 203.659 552.222 224.501c-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281C285.169 375.812 284.017 372.431 284 375.306 283.983 372.431 282.831 375.812 280.369 383.039c-13.43 39.422-65.842 193.273-185.7023 70.281C31.5556 388.56 60.7778 323.8 175.653 304.249 109.933 315.434 36.0535 296.954 15.7778 224.501 9.94525 203.659.0 75.2916.0 57.9464.0-28.9064 76.1345-1.61183 123.121 33.6637z"/></svg></a><a href=https://mastodon-belgium.be/@TerraGloba target=_blank class="u-url social" rel="external noopener me" title=Mastodon>
<svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><path fill="currentcolor" d="M20.94 14c-.28 1.41-2.44 2.96-4.97 3.26-1.31.15-2.6.3-3.97.24-2.25-.11-4-.54-4-.54v.62c.32 2.22 2.22 2.35 4.03 2.42 1.82.05 3.44-.46 3.44-.46l.08 1.65s-1.28.68-3.55.81c-1.25.07-2.81-.03-4.62-.5-3.92-1.05-4.6-5.24-4.7-9.5l-.01-3.43c0-4.34 2.83-5.61 2.83-5.61C6.95 2.3 9.41 2 11.97 2h.06c2.56.0 5.02.3 6.47.96.0.0 2.83 1.27 2.83 5.61.0.0.04 3.21-.39 5.43M18 8.91c0-1.08-.3-1.91-.85-2.56-.56-.63-1.3-.96-2.23-.96-1.06.0-1.87.41-2.42 1.23l-.5.88-.5-.88c-.56-.82-1.36-1.23-2.43-1.23-.92.0-1.66.33-2.23.96C6.29 7 6 7.83 6 8.91v5.26h2.1V9.06c0-1.06.45-1.62 1.36-1.62 1 0 1.5.65 1.5 1.93v2.79h2.07V9.37c0-1.28.5-1.93 1.51-1.93.9.0 1.35.56 1.35 1.62v5.11H18V8.91z"/></svg></a><a href=https://github.com/TheGroundZero target=_blank class="u-url social" rel="external noopener me" title=Github><svg width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a href=https://twitter.com/DezeStijn target=_blank class="u-url social" rel="external noopener me" title=Twitter><svg width="1.2em" height="1.2em" viewBox="0 0 16 16"><path fill="currentcolor" d="M5.032 14.286c6.037.0 9.34-4.837 9.34-9.032.0-.137.0-.274-.01-.41A6.56 6.56.0 0016 3.2c-.6.256-1.235.425-1.885.5a3.207 3.207.0 001.443-1.757c-.645.37-1.35.63-2.085.77a3.322 3.322.0 00-1.862-.958 3.384 3.384.0 00-2.082.334 3.223 3.223.0 00-1.442 1.49 3.08 3.08.0 00-.208 2.03 9.57 9.57.0 01-3.747-.963A9.269 9.269.0 011.114 2.292a3.086 3.086.0 00-.36 2.314c.189.787.68 1.475 1.376 1.924A3.344 3.344.0 01.64 6.132v.04c0 .734.263 1.444.743 2.01a3.3 3.3.0 001.89 1.102c-.483.128-.99.146-1.482.055a3.19 3.19.0 001.168 1.577 3.36 3.36.0 001.9.627A6.732 6.732.0 010 12.86a9.527 9.527.0 005.032 1.423"/></svg></a><a href=https://ko-fi.com/s4squatch target=_blank class="u-url social" rel="external noopener" title=Kofi><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><path fill="currentcolor" d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604.0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407.0.0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311zm6.173.478c-.928.116-1.682.028-1.682.028V7.284h1.77s1.971.551 1.971 2.638c0 1.913-.985 2.667-2.059 3.015z"/></svg></a><p class=footnote>&copy; 2019
• <a class="p-name u-url" href=https://sequr.be>Sequr</a>
• <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="external noopener">CC BY-NC-SA 4.0</a></p><a href=https://sequr.be/en hreflang=en-US title=English class=u-translation-of rel=alternate><span class="flag fi fi-gb"></span>
</a><a href=https://sequr.be/nl hreflang=nl-BE title=Nederlands class=u-translation-of rel=alternate><span class="flag fi fi-nl"></span></a></div></aside><section class="content container"><article class="post h-entry"><header class=info><h1 class="post-title p-name u-url"><a href=https://sequr.be/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/ rel=bookmark>Flashing NSPanel with Tasmota and NSPanel Lovelace UI</a></h1><div class=headline><div><span class="h-card p-author">DezeStijn</span><span class=whitespace> • </span><time datetime=2023-01-14T00:00:00+0100 class="post-date dt-published">Jan 14, 2023</time><span class=whitespace> • </span><span class=reading-time><span>12 mins read</span></span></div><ul class=tags><li class="tag-Home Automation"><a class=p-category href=https://sequr.be/categories/home-automation>Home Automation</a></li></ul></div></header><main class=e-content><h2 id=intro>Intro</h2><p>The <a href=https://sonoff.tech/product/central-control-panel/nspanel/ title="Sonoff NSPanel" rel=external target=_blank>Sonoff NSPanel</a> is a fancy little combination of a dual-gang switch and a control panel.
Out of the box it allows for a lot of customisation via the eWeLink App, giving you control of more than just the 2 devices you connect to its relays.</p><p>However, since we &ndash; as Home Assistant enthusiasts &ndash; prefer to manage our own device and not be dependant on a 3rd party app, we&rsquo;re going to flash the NSPanel with Tasmota :)
Note that ESPHome is also an option, since the NSPanel is equiped with an ESP32. I might do a blog post about that as well some day.</p><p>Luckily, Blakadder has done a terrific job of <a href=https://blakadder.com/nspanel-teardown/ title="Blakadder NSPanel Teardown" rel=external target=_blank>tearing down</a> the insides of the NSPanel and identifying the ESP32 chip and pins needed to flash the device.
He has also laid the foundation for flashing Tasmota on the NSPanel, which projects like <a href=https://github.com/joBr99/nspanel-lovelace-ui title="NSPanel Lovelace UI" rel=external target=_blank>NSPanel Lovelace UI</a> have built further upon.</p><p>In this blog post, I&rsquo;ll discuss my experiences with installing NSPanel Lovelace UI on my NSPanel.
This will also include installing AppDaemon in Docker using docker-compose since I&rsquo;m running <a href=/categories/ha-container/ title="HA Container series">HA Container</a>.</p><p>Since I switched to using Podman in <a href=/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/ title="Home Assistant Container Part 12: Migrating to Podman">Part 12 of the Home Assistant Container series</a>, I&rsquo;ll be sharing my Podman config instead of the Docker-compose config you can find in the NSPanel Lovelace docs.</p><h2 id=preparations>Preparations</h2><h3 id=get-home-assistant-long-lived-access-token>Get Home Assistant Long-Lived Access Token</h3><p>The AppDaemon container will connect to our Home Assistant instance.
To authenticate, it will need a <a href=https://www.home-assistant.io/docs/authentication/ title="Authentication on Home Assistant docs" rel=external target=_blank>Long-Lived Access Tokens</a>.</p><ul><li>Login on Home Assistant as the user AppDaemon will authenticate as</li><li>Click on your username at the bottom-left</li><li>Scroll to the bottom, where you&rsquo;ll find the &ldquo;Long-Lived Access Tokens&rdquo; section</li><li>Create a new token, give it a name, and copy the generated token (it will only be displayed once!)</li></ul><figure class=center><img src=ha-llat.png alt="Long-Lived Access Tokens in Home Assistant"><figcaption class=center>Long-Lived Access Token</figcaption></figure><p>Keep this token in a txt file or in your password manager, you&rsquo;ll need it later!</p><h3 id=create-mqtt-users>Create MQTT user(s)</h3><p>In <a href=/blog/2022/09/home-assistant-container-part-4-mosquitto-docker-container/ title="Home Assistant Container Part 4: Mosquitto Docker Container">part 4</a> of our HA Container series we set up the Mosquitto MQTT broker and created and account for Home Assistant.</p><p>We&rsquo;ll add 2 more accounts: 1 for AppDaemon and 1 for Tasmota devices.
Make sure you write down the passwords somewhere.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>podman exec -it mosquitto mosquitto_passwd /mosquitto/config/mqttuser appdaemon_mqtt
</span></span><span style=display:flex><span><span style=color:#75715e># Enter password</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Repeat password</span>
</span></span><span style=display:flex><span>podman exec -it mosquitto mosquitto_passwd /mosquitto/config/mqttuser tasmota_mqtt
</span></span><span style=display:flex><span><span style=color:#75715e># Enter password</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Repeat password</span>
</span></span></code></pre></div><p>Swap <code>podman</code> for <code>docker</code> in the commands above if necessary.</p><p><strong>!</strong> If you&rsquo;re copying the command from the Mosquitto blog post, make sure you drop the <code>-c</code> parameter as that will wipe out any existing accounts.</p><h2 id=appdaemon-installation-and-configuration>AppDaemon installation and configuration</h2><p>This could be an additional post in the <a href=/categories/ha-container/ title="HA Container series">HA Container series</a> as this point, as it&rsquo;s sort of a repetition of what we&rsquo;ve done multiple times before.</p><h3 id=podman-configuration>Podman configuration</h3><p>Have a look at <a href=/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/ title="Home Assistant Container Part 12: Migrating to Podman">HA Container Series pt12</a> if you want to learn more about the config below.</p><p>It&rsquo;s of the utmost importance you mount the AppDeamon <code>config</code> folder <strong>inside the HA config folder</strong>!
This does mean the HA config volume needs to be labeled with a lowercase <code>:z</code> (in the HA container and the AppDaemon config) to indicate this volume is shared.</p><p><code>~/.config/systemd/user/container-appdaemon.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>AppDaemon</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>container</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>network-online</span>.<span style=color:#a6e22e>target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-homeassistant</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-homeassistant</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span>=<span style=color:#a6e22e>container-mosquitto</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span>=<span style=color:#a6e22e>container-mosquitto</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RequiresMountsFor</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>containers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span>=<span style=color:#a6e22e>PODMAN_SYSTEMD_UNIT</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>n</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#a6e22e>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>Brussels</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span>=<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStopSec</span>=<span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>appdaemon-secrets</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secret</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>appdaemon-secrets</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>run</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--cgroups</span>=<span style=color:#a6e22e>no-conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--rm</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--sdnotify</span>=<span style=color:#a6e22e>conmon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--replace</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--detach</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--label</span> <span style=color:#e6db74>&#34;io.containers.autoupdate=registry&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--name</span> <span style=color:#a6e22e>appdaemon</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--group-add</span> <span style=color:#a6e22e>keep-groups</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--network</span>=<span style=color:#a6e22e>slirp4netns</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>allow_host_loopback</span>=<span style=color:#66d9ef>true</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--volume</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>srv</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>hass</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>appdaemon</span><span style=color:#960050;background-color:#1e0010>:/</span><span style=color:#a6e22e>conf</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>z</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--env</span> <span style=color:#a6e22e>TZ</span>=<span style=color:#e6db74>&#34;Europe/Brussels&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--env</span> <span style=color:#a6e22e>HA_URL</span>=<span style=color:#e6db74>&#34;!secret ha_url&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--env</span> <span style=color:#a6e22e>TOKEN</span>=<span style=color:#e6db74>&#34;!secret ha_token&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--env</span> <span style=color:#a6e22e>DASH_URL</span>=<span style=color:#e6db74>&#34;!secret dash_url&#34;</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>--secret</span>=<span style=color:#a6e22e>appdaemon-secrets</span>,<span style=color:#a6e22e>target</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>conf</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>secrets</span>.<span style=color:#a6e22e>yaml</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>-p</span> <span style=color:#ae81ff>5050</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>5050</span> <span style=color:#960050;background-color:#1e0010>\</span>
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>docker</span>.<span style=color:#a6e22e>io</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>acockburn</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>appdaemon</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>-f</span> <span style=color:#a6e22e>--ignore</span> <span style=color:#a6e22e>--cidfile</span>=<span style=color:#960050;background-color:#1e0010>%</span><span style=color:#a6e22e>t</span><span style=color:#960050;background-color:#1e0010>/%</span><span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>ctr-id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStopPost</span>=<span style=color:#a6e22e>-</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>podman</span> <span style=color:#a6e22e>secret</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>appdaemon-secrets</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>oneshot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NotifyAccess</span>=<span style=color:#a6e22e>all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><p><code>/srv/hass/secret/appdaemon-secrets</code></p><pre tabindex=0><code>ha_url: http://10.0.2.2:8123
ha_token: &#34;&lt;Long-Lived Access Token&gt;&#34;
mqtt_host: 10.0.2.2
mqtt_user: appdaemon_mqtt
mqtt_pass: &lt;appdaemon_mqtt password&gt;
dash_url: http://&lt;ip.of.our.box&gt;:5050
</code></pre><p>Don&rsquo;t forget to create the directory for the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /srv/hass/hass/appdaemon
</span></span></code></pre></div><p>Don&rsquo;t start the container just yet, we want to make a few more changes to the AppDaemon config first.</p><h3 id=install-babel-dependency>Install Babel dependency</h3><p><a href=https://babel.pocoo.org/en/latest/ title="Babel documentation" rel=external target=_blank>Babel</a> is used by AppDaemon for localization (e.g. date formats).</p><p>We can add this as a Python dependency by adding it to our <code>requirements.txt</code>.
This file most likely doesn&rsquo;t exist yet and must be created inside the container&rsquo;s <code>/conf</code> folder.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Babel&#34;</span> &gt;&gt; /srv/hass/hass/appdaemon/requirements.txt
</span></span></code></pre></div><p>If you had already started the container, a restart of the container will ensure the dependency is discovered and installed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user restart container-appdaemon.service
</span></span></code></pre></div><h3 id=appdaemon-app-configuration>AppDaemon app configuration</h3><p>The main configuration for AppDaemon is located at <code>/srv/hass/hass/appdaemon/appdaemon.yaml</code> or the appdeamon folder inside the HA container.</p><p>Copy/paste this config there to ensure MQTT is set up and our secrets from earlier are being used.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>secrets</span>: <span style=color:#ae81ff>/conf/secrets.yaml </span> <span style=color:#75715e># IMPORTANT! Otherwise !secret won&#39;t work</span>
</span></span><span style=display:flex><span><span style=color:#f92672>appdaemon</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>latitude</span>: <span style=color:#75715e>##.##########</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>longitude</span>: <span style=color:#75715e>##.##########</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>elevation</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>time_zone</span>: !<span style=color:#ae81ff>env_var TZ</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>plugins</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>HASS</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>hass</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ha_url</span>: !<span style=color:#ae81ff>secret ha_url</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>token</span>: !<span style=color:#ae81ff>secret ha_token</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>MQTT</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>mqtt</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>mqtt</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_id</span>: <span style=color:#e6db74>&#34;appdaemon&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_host</span>: !<span style=color:#ae81ff>secret mqtt_host</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_port</span>: <span style=color:#ae81ff>1883</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_user</span>: !<span style=color:#ae81ff>secret mqtt_user</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_password</span>: !<span style=color:#ae81ff>secret mqtt_pass</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>client_topics</span>: <span style=color:#ae81ff>NONE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>url</span>: !<span style=color:#ae81ff>secret dash_url</span>
</span></span><span style=display:flex><span><span style=color:#f92672>admin</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>api</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>hadashboard</span>:
</span></span></code></pre></div><h3 id=start-the-container>Start the container</h3><p>Enable the service to start the container at boot, and start it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user enable --now container-appdaemon.service
</span></span></code></pre></div><p>After running the command, the container image will be pulled and the container will be started.
The AppDaemon dashboard will be available at <code>http://&lt;ip.of.our.box>:5050</code>.
Some default configurations will be added to the <code>/conf</code> folder inside the container as well.</p><h3 id=minimal-nspanel-config>Minimal NSPanel config</h3><p>The configuration for the NSPanel is stored in an AppDeamon app.</p><p>Below is a minimal config to get started.
Store this config in <code>/srv/hass/hass/appdaemon/apps/apps.yaml</code>. Delete the hello-world app if it&rsquo;s present.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>nspanel-1</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>module</span>: <span style=color:#ae81ff>nspanel-lovelace-ui</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>class</span>: <span style=color:#ae81ff>NsPanelLovelaceUIManager</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>panelRecvTopic</span>: <span style=color:#e6db74>&#34;tele/tasmota_&lt;your_mqtt_topic&gt;/RESULT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>panelSendTopic</span>: <span style=color:#e6db74>&#34;cmnd/tasmota_&lt;your_mqtt_topic&gt;/CustomSend&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>model</span>: <span style=color:#ae81ff>eu</span>
</span></span></code></pre></div><p>Modify <code>&lt;your_mqtt_topic></code> to something specific for your NSPanel and keep note as we&rsquo;ll need it later.</p><p>You can add multiple configs for multiple NSPanels.
Make sure you use unique MQTT topics for each.</p><h2 id=install-lovelace-appdaemon-backend>Install Lovelace AppDaemon Backend</h2><h3 id=enable-appdeamon-automations-in-hacs>Enable AppDeamon automations in HACS</h3><p>Next, we&rsquo;ll install the Lovelace AppDaemon Backend application in Home Assistant.
We&rsquo;ll install this from <a href=https://hacs.xyz/ title="HACS - Home Assistant Community Store" rel=external target=_blank>HACS</a>.</p><p>We&rsquo;ll assume you already have HACS installed.
This blog post won&rsquo;t go into details on how to install HACS.</p><ol><li>Go to <code>Settings</code> > <code>Devices & Services</code> in Home Assistant.</li><li>Press the <code>Configure</code> button under the HACS integration.</li><li>Ensure <code>Enable AppDaemon apps discovery & tracking</code> is selected.</li></ol><figure class=center><img src=hacs-automations.png alt="Enable 'Enable AppDaemon apps discovery & tracking&#39; in HACS config"><figcaption class=center>Enable AppDaemon apps discovery & tracking</figcaption></figure><ol><li>Open the <code>HACS</code> store.</li><li>Go to the <code>Automations</code> section.</li><li>Click <code>Explore & download repositories</code>.</li><li>Search for <code>NSPanel Lovelace UI Backend</code>.</li><li>Download the repository.</li></ol><figure class=center><img src=hacs-nspanel.png alt="Download the 'NSPanel Lovelace UI Backend' repository"><figcaption class=center>NSPanel Lovelace UI Backend</figcaption></figure><h2 id=flash-tasmota-on-nspanel>Flash Tasmota on NSPanel</h2><p>Finally we&rsquo;ll flash Tasmota on the NSPanel.</p><p>You&rsquo;ll need to disassemble the NSPanel using a flathead screwdriver or a prying tool and a small Philips head screwdriver.
The <a href=https://s.click.aliexpress.com/e/_Dd6aqNt title="Wowstick Mini Precision Electric Screwdriver" rel=external target=_blank>Wowstick</a> comes in handy here.</p><p>You can check how to open the Touch Plate and what the pinout of the PCB is in <a href=https://blakadder.com/nspanel-teardown/ title="Blakadder NSPanel Teardown" rel=external target=_blank>Blakadder&rsquo;s teardown</a>.</p><figure class=center><img src=nspanel-pinout.jpg alt="NSPanel pinout"><figcaption class=center>Pinout of the NSPanel</figcaption></figure><h3 id=serial-connection-to-the-nspanel>Serial connection to the NSPanel</h3><ol><li>Set your <a href=https://www.aliexpress.com/item/32650148276.html title="FT232RL FTDI USB 3.3V 5.5V to TTL Serial Adapter Module" rel=external target=_blank>serial adapter</a> to 3.3V</li><li>Connect it to the GND, ESP_RX, ESP_TX, and 3V3 pins on the PCB (marked yellow in the picture above).<br>Make sure you cross RX-TX between the NSPanel and the FTDI.</li><li>Grab a <a href=https://s.click.aliexpress.com/e/_A9gQql title="Dupont wires - male-male, male-female, female-female - 10cm" rel=external target=_blank>Dupont wire</a> and connect it between the IO0 and one of the GND pins at the right (next to the 5V pins) to force the NSPanel to boot in flash mode.</li><li>While putting some pressure on the Dupont wires to ensure a good connection, connect the FTDI to your computer.</li></ol><figure class=center><img src=nspanel-ftdi.png alt="Picture of FTDI connected to the NSPanel"><figcaption class=center>Connect FTDI to NSPanel</figcaption></figure><h3 id=flash-tasmota>Flash Tasmota</h3><ol><li>Open the <a href=https://tasmota.github.io/install/ title="Tasmota Web Installer" rel=external target=_blank>Tasmota Web Installer</a> in Chrome or Edge as the browser needs to be able to connect to your serial device.</li><li>Select <code>Tasmota32 Sonoff-NSPanel (english)</code>.</li><li>Press <code>Connect</code>.</li><li>In the pop-up, select your serial device.</li><li>Flash Tasmota.</li></ol><figure class=center><img src=tasmota-installer.png alt="Tasmota Web Installer"><figcaption class=center>Tasmota Web Installer</figcaption></figure><h3 id=connect-nspanel-to-your-wifi>Connect NSPanel to your WiFi</h3><p>You can connect the NSPanel with your WiFi via the captive portal that is now active on the NSPanel or via the Web Installer.</p><ol><li>Disconnect the FTDI from the NSPanel</li><li>Set the FTDI to 5V</li><li>Connect GND and VCC on the FTDI to 5V and GND on the NSPanel (marked red in the pinout above)</li><li>Connect RX and TX on the FTDI to ESP_TX and ESP_TX on the NSPanel (marked yellow)</li><li>Do NOT connected GPIO0 to GND!</li><li>In the Tasmota Web Installer, reconnect to your device</li><li>Select the option to connect to WiFi</li><li>Pick the correct SSID and enter the password</li></ol><h2 id=configure-tasmota-for-nspanel>Configure Tasmota for NSPanel</h2><p>The final configuration of the NSPanel is done via the Tasmota Web UI.
Check in your router&rsquo;s DHCP table which IP the NSPanel has.</p><p>You can also assemble the NSPanel again and power it from mains as we won&rsquo;t need access to the PCB anymore.</p><h3 id=nspanel-template>NSPanel template</h3><ol><li>Go to <code>Configuration</code></li><li>Pick <code>Configure Other</code></li><li>Paste the following template in the input field:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;NAME&#34;</span>:<span style=color:#e6db74>&#34;NSPanel&#34;</span>,<span style=color:#f92672>&#34;GPIO&#34;</span>:[<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>3872</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>32</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>225</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>480</span>,<span style=color:#ae81ff>224</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>33</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>4736</span>,<span style=color:#ae81ff>0</span>],<span style=color:#f92672>&#34;FLAG&#34;</span>:<span style=color:#ae81ff>0</span>,<span style=color:#f92672>&#34;BASE&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;CMND&#34;</span>:<span style=color:#e6db74>&#34;ADCParam1 2,11200,10000,3950 | Sleep 0 | BuzzerPWM 1&#34;</span>}
</span></span></code></pre></div></li><li>Tick the <code>Activate</code> checkbox</li><li>Save</li></ol><p>The NSPanel will now reboot and the main screen will display 2 toggles for the relays and the read-out of the temperature sensor.</p><h3 id=berry-driver>Berry Driver</h3><h4 id=console>Console</h4><p>Execute the following command in the Tasmota Console to download the Berry Driver and reboot the device:</p><pre tabindex=0><code>Backlog UrlFetch https://raw.githubusercontent.com/joBr99/nspanel-lovelace-ui/main/tasmota/autoexec.be; Restart 1
</code></pre><h4 id=manually>Manually</h4><ol><li>Download the <a href=https://raw.githubusercontent.com/joBr99/nspanel-lovelace-ui/main/tasmota/autoexec.be title="Berry Driver autoexec.be" rel=external target=_blank>Berry Driver</a> from the NSPanel Lovelace UI repository and save as <code>autoexec.be</code>.</li><li>On the Tasmota Web UI go to <code>Consoles</code> > <code>Manage File System</code>.</li><li>Upload the <code>autoexec.be</code> you just downloaded.</li><li>Reboot the NSPanel</li></ol><h3 id=flash-the-firmware>Flash the firmware</h3><ol><li>Go to <code>Consoles</code> > <code>Console</code>.</li><li>Paste the following command in the input field and press Return to run it:<pre tabindex=0><code>FlashNextion http://nspanel.pky.eu/lui-release.tft
</code></pre></li></ol><p>The NSPanel should now display a loadscreen showing it&rsquo;s downloading and flashing the TFT.
This will also be reflected in the Logs.</p><pre tabindex=0><code>22:34:43.031 CMD: FlashNextion http://nspanel.pky.eu/lui-release.tft
22:34:43.042 RSL: RESULT = {&#34;FlashNextion&#34;:&#34;Done&#34;}
22:34:43.082 FLH: host: nspanel.pky.eu, port: 80, get: /lui-release.tft
22:34:44.467 FLH: Something has gone wrong flashing display firmware [bytes(&#39;1AFFFFFF&#39;)]
22:34:44.569 FLH: Send (High Speed) flash start
22:34:44.974 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 0, &#34;time_elapsed&#34;: 0}}
22:34:48.522 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 1, &#34;time_elapsed&#34;: 3}}
22:34:51.460 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 2, &#34;time_elapsed&#34;: 6}}
22:34:54.398 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 3, &#34;time_elapsed&#34;: 9}}
22:34:57.341 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 4, &#34;time_elapsed&#34;: 12}}
22:35:00.594 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 5, &#34;time_elapsed&#34;: 16}}
22:35:03.532 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 6, &#34;time_elapsed&#34;: 18}}
22:35:06.460 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 7, &#34;time_elapsed&#34;: 21}}
22:35:09.393 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 8, &#34;time_elapsed&#34;: 24}}
22:35:12.364 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 9, &#34;time_elapsed&#34;: 27}}
22:35:15.593 RSL: RESULT = {&#34;Flashing&#34;:{&#34;complete&#34;: 10, &#34;time_elapsed&#34;: 31}}
</code></pre><p>If your NSPanel doesn&rsquo;t have a (reliable) connection to the internet,
you can download the <code>lui-release.tft</code> locally and use your own webserver, like the one from Home Assistant.</p><ol><li>Download <a href=http://nspanel.pky.eu/lui-release.tft rel=external target=_blank>http://nspanel.pky.eu/lui-release.tft</a></li><li>Copy this file to <code>/srv/hass/hass/www/</code> (the <code>www</code> folder in Home Assistant)</li><li>Run the same command, but referring to Home Assitant:<br><code>FlashNextion http://&lt;ip.of.you.ha>:8123/local/lui-release.tft</code></li></ol><h3 id=set-up-mqtt-in-tasmota>Set up MQTT in Tasmota</h3><p>Via the Tasmota Web UI, set up MQTT:</p><ol><li>Go to <code>Configuration</code></li><li>Go to <code>Configure MQTT</code></li><li>Enter your MQTT information, such as the host, client and password, and topic<br>Do NOT modify the Full Topic (<code>%prefix%/%topic%/</code>)</li></ol><figure class=center><img src=tasmota-mqtt.png alt="Tasmota MQTT config"><figcaption class=center>Tasmota MQTT config</figcaption></figure><h2 id=configure-views-in-nspanel-lovelace-ui>Configure views in NSPanel Lovelace UI</h2><p>Now we can start setting up our Lovelace dashboards for the NSPanel.</p><p>To modify the views, make changes to the <code>apps.yaml</code> file.
Each <code>card</code> is a view/page/dashboard between which you can scroll.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>nspanel-bureau</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>module</span>: <span style=color:#ae81ff>nspanel-lovelace-ui</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>class</span>: <span style=color:#ae81ff>NsPanelLovelaceUIManager</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>panelRecvTopic</span>: <span style=color:#e6db74>&#34;tele/tasmota_&lt;your_mqtt_topic&gt;/RESULT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>panelSendTopic</span>: <span style=color:#e6db74>&#34;cmnd/tasmota_&lt;your_mqtt_topic&gt;/CustomSend&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>updateMode</span>: <span style=color:#e6db74>&#34;auto-notify&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>model</span>: <span style=color:#ae81ff>eu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>locale</span>: <span style=color:#e6db74>&#34;nl_NL&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>screenBrightness</span>: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sleepBrightness</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>time</span>: <span style=color:#e6db74>&#34;8:45:00&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>time</span>: <span style=color:#e6db74>&#34;18:15:00&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sleepOverride</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>light.desk</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>brightness</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>screensaver</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>weather.forecast_home</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>theme</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>autoWeather</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cards</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>cardThermo</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Office</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>climate.trv_office</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>cardThermo</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Living Room</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>climate.resideo_thermostat</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>cardEntities</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Office</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>entities</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>light.office</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>light.desk</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>entity</span>: <span style=color:#ae81ff>input_boolean.in_call</span>
</span></span></code></pre></div><p>Check the <a href=https://docs.nspanel.pky.eu/config-overview/ title="NSPanel Lovelace UI documentation" rel=external target=_blank>documentation</a> for more info.</p><h2 id=mount-the-nspanel>Mount the NSPanel</h2><p>When you&rsquo;re certain your desk setup is working, it&rsquo;s time to mount the NSPanel to its final location.
In my case, I decided to swap the light switch of my office for the NSPanel.</p><p>First, I had to remove the old wall-box as it was too small and didn&rsquo;t support screw-installation faceplates.
Once that was done, I could wire up the NSPanel, which was really easy to do.</p><p>Connect the Live wire that used to go to the switch, to the L terminal.
Neutral goes to N.
The switched Live from the light went to the S2 terminal in my case, as that matches the right-side button which made most sense in my setup.</p><p>I didn&rsquo;t have a 2nd light to connect to the other relais output, but I&rsquo;m planning to use that button as a trigger for an automation.</p><figure class=center><img src=cover.png alt="NSPanel installed on the wall, showing the weather screensaver"><figcaption class=center>NSPanel installed on the wall</figcaption></figure><p>Yes, the protective cover is still on the screen (:</p><h2 id=upgrading-nspanel>Upgrading NSPanel</h2><p>Every now and then an update for NSPanel Lovelace UI becomes available through HACS.</p><p>After installing that update, you&rsquo;ll need to restart the AppDeamon container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl --user restart container-appdaemon.service
</span></span></code></pre></div><p>Your NSPanel will shortly after that restart notify you an update is available for it and will ask you whether you want to install it.
Of course you should click <em>Yes</em> there!</p><p>Clicking <em>Yes</em> will download and flash the latest TFT onto the NSPanel.</p><p>IF your NSPanel can&rsquo;t access the internet, or the flashing doesn&rsquo;t seem to work for some reason,
have a look at <a href=/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/#flash-the-firmware title="Flash the firmware">Flash the firmware</a> on how to do it from a local webserver.</p><h2 id=troubleshooting>Troubleshooting</h2><p>Here are some issues I encountered while flashing my NSPanel so I thought it&rsquo;d be a good idea to share this info with you.</p><h3 id=tft-not-downloading>TFT not downloading</h3><p>If you don&rsquo;t see the TFT being downloaded when running the <code>FlashNextion</code> command, it can help to reflash Tasmota.</p><ol><li>Go to <code>Firmware Upgrade</code> in the Tasmota web portal.</li><li>Enter the following OTA URL: <code>http://ota.tasmota.com/tasmota32/release/tasmota32-nspanel.bin</code>.</li><li>Press <code>Start Upgrade</code>.</li><li>Wait about 5 minutes until the firmware reinstall is finished.</li></ol><p>Once the reinstall is finished, repeat the steps from the <a href=/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/#configure-tasmota-for-nspanel title="Configure Tasmota for NSPanel">Configure Tasmota for NSPanel</a> section.</p><h3 id=date-on-screensaver-doesnt-match-my-config>Date on screensaver doesn&rsquo;t match my config</h3><p>If you&rsquo;re using <code>dateFormatBabel</code> and/or <code>locale</code> in your <code>apps.yaml</code> to configure the datetime format on your screensaver, you need to confirm Babel is installed on your system.
If not, the screensaver will display the date using the default datetime format.</p><p>See <a href=/blog/2023/01/flashing-nspanel-with-tasmota-and-nspanel-lovelace-ui/#install-babel-dependency title="Install Babel dependency">Install Babel dependency</a>.</p><p>The AppDaemon logs should womething like:</p><pre tabindex=0><code>Collecting Babel
  Downloading Babel-2.11.0-py3-none-any.whl (9.5 MB)
Requirement already satisfied: pytz&gt;=2015.7 in /usr/local/lib/python3.9/site-packages (from Babel-&gt;-r /conf/requirements.txt (line 1)) (2021.3)
Installing collected packages: Babel
Successfully installed Babel-2.11.0
</code></pre><p>Alternatively, you can configure the date using <code>dateFormat</code> and the <a href=https://www.w3schools.com/python/gloss_python_date_format_codes.asp title="Python Date Format Codes" rel=external target=_blank>Python Date Format Codes</a>.
However, the displayed date will not be localised.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>nspanel-1</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Fri 18 November</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dateFormatBabel</span>: <span style=color:#e6db74>&#34;EE d MMMM&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># vrijdag 18 november 2022</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>locale</span>: <span style=color:#e6db74>&#34;nl_NL&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># vr 18 november</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>locale</span>: <span style=color:#e6db74>&#34;nl_NL&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dateFormatBabel</span>: <span style=color:#e6db74>&#34;EE d MMMM&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Friday 18 November 2022</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dateFormat</span>: <span style=color:#e6db74>&#34;%A %d %B %Y&#34;</span>
</span></span></code></pre></div></main><hr><footer><div class=footer><p><div class=previous-post><a href="https://sequr.be/blog/2022/12/home-assistant-container-part-12-migrating-to-podman/?ref=footer"><span style=font-weight:700>« Previous</span><br>Home Assistant Container Part 12: Migrating to...</a><div class=next-post><a href="https://sequr.be/blog/2023/02/manage-mercedes-ev-battery-charge-target-from-home-assistant/?ref=footer"><span style=font-weight:700>Next »</span><br>Manage Mercedes EV battery charge target from Home...</a></div></p></div></footer></article></section><aside class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#preparations>Preparations</a><ul><li><a href=#get-home-assistant-long-lived-access-token>Get Home Assistant Long-Lived Access Token</a></li><li><a href=#create-mqtt-users>Create MQTT user(s)</a></li></ul></li><li><a href=#appdaemon-installation-and-configuration>AppDaemon installation and configuration</a><ul><li><a href=#podman-configuration>Podman configuration</a></li><li><a href=#install-babel-dependency>Install Babel dependency</a></li><li><a href=#appdaemon-app-configuration>AppDaemon app configuration</a></li><li><a href=#start-the-container>Start the container</a></li><li><a href=#minimal-nspanel-config>Minimal NSPanel config</a></li></ul></li><li><a href=#install-lovelace-appdaemon-backend>Install Lovelace AppDaemon Backend</a><ul><li><a href=#enable-appdeamon-automations-in-hacs>Enable AppDeamon automations in HACS</a></li></ul></li><li><a href=#flash-tasmota-on-nspanel>Flash Tasmota on NSPanel</a><ul><li><a href=#serial-connection-to-the-nspanel>Serial connection to the NSPanel</a></li><li><a href=#flash-tasmota>Flash Tasmota</a></li><li><a href=#connect-nspanel-to-your-wifi>Connect NSPanel to your WiFi</a></li></ul></li><li><a href=#configure-tasmota-for-nspanel>Configure Tasmota for NSPanel</a><ul><li><a href=#nspanel-template>NSPanel template</a></li><li><a href=#berry-driver>Berry Driver</a><ul><li><a href=#console>Console</a></li><li><a href=#manually>Manually</a></li></ul></li><li><a href=#flash-the-firmware>Flash the firmware</a></li><li><a href=#set-up-mqtt-in-tasmota>Set up MQTT in Tasmota</a></li></ul></li><li><a href=#configure-views-in-nspanel-lovelace-ui>Configure views in NSPanel Lovelace UI</a></li><li><a href=#mount-the-nspanel>Mount the NSPanel</a></li><li><a href=#upgrading-nspanel>Upgrading NSPanel</a></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#tft-not-downloading>TFT not downloading</a></li><li><a href=#date-on-screensaver-doesnt-match-my-config>Date on screensaver doesn&rsquo;t match my config</a></li></ul></li></ul></nav></div></aside></div></body></html>