<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-US lang=en-US><head><title itemprop=name>Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome :: Sequr</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="noodp, noydir"><meta name=googlebot content="noodp, noydir"><meta name=url content="https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/" itemprop=url><link rel=icon href=/favicon.ico><meta itemprop=name content="Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome"><meta itemprop=description content="Monitoring room temperature and humidity using cheap Xiaomi sensors, a ESP32 board and ESPHome. Tutorial for LYWSD03MMC, LYWSDCGQ, CGG1 and LYWSD02."><meta itemprop=datePublished content="2021-01-12T19:00:00+01:00"><meta itemprop=dateModified content="2021-05-18T01:00:00+01:00"><meta itemprop=wordCount content="2993"><meta itemprop=image content="https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,Xiaomi,Temperature,Humidity,Sensor,ESP32,ESPHome,Bluetooth"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/cover.png"><meta name=twitter:title content="Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome"><meta name=twitter:description content="Monitoring room temperature and humidity using cheap Xiaomi sensors, a ESP32 board and ESPHome. Tutorial for LYWSD03MMC, LYWSDCGQ, CGG1 and LYWSD02."><meta property="og:url" content="https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/"><meta property="og:site_name" content="Sequr"><meta property="og:title" content="Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome"><meta property="og:description" content="Monitoring room temperature and humidity using cheap Xiaomi sensors, a ESP32 board and ESPHome. Tutorial for LYWSD03MMC, LYWSDCGQ, CGG1 and LYWSD02."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-01-12T19:00:00+01:00"><meta property="article:modified_time" content="2021-05-18T01:00:00+01:00"><meta property="article:tag" content="Home Automation"><meta property="article:tag" content="Home Assistant"><meta property="article:tag" content="Xiaomi"><meta property="article:tag" content="Temperature"><meta property="article:tag" content="Humidity"><meta property="article:tag" content="Sensor"><meta property="og:image" content="https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/cover.png"><meta name=description content="Monitoring room temperature and humidity using cheap Xiaomi sensors, a ESP32 board and ESPHome. Tutorial for LYWSD03MMC, LYWSDCGQ, CGG1 and LYWSD02."><meta property="og:updated_time" content="2021-05-18T01:00:00+01:00"><link rel=sitemap type=application/xml title=Sitemap href=https://sequr.be/sitemap.xml><meta name=apple-mobile-web-app-title content="Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><link rel=webmention href=https://webmention.io/sequr.be/webmention><link rel=stylesheet href=/css/bundle.min.d5e880fa47b06e255559be782bda42cfdb7c345456e9afd14dd12d12f81f69be.css integrity="sha256-1eiA+kewbiVVWb54K9pCz9t8NFRW6a/RTdEtEvgfab4=" crossorigin=anonymous><script defer type=text/javascript src=/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js integrity="sha256-FFRTJhp3VfUEKoVMQhNQHSFaj740wI0YHED4A/ExXnQ=" crossorigin=anonymous></script></head><body class=dark-theme><div class=wrapper><aside class="sidebar h-card background-image"><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class="sidebar-about hcard"><h1 class=brand><a href=https://sequr.be/><img src=/logo.png class="u-logo u-photo" alt="Sequr brand image">
</a><a href=https://sequr.be/ class="u-url p-org"><h1>Sequr</h1></a></h1><p class="lead p-note">Writeups and random stuff about infosec and life</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/ title=About>About</a></li><li class=heading><a href=/blog/ title=Blog>Blog</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=/blog/2025/01/bridging-this-blog-with-the-fediverse/ title="Bridging this blog with the Fediverse" hreflang=en>Briding with the Fediverse</a></li><li class=bullet><a href=/blog/2025/01/new-year-new-theme-for-the-site/ title="New year, new theme for the site" hreflang=en>New theme</a></li><li class=bullet><a href=/blog/2024/09/flashing-the-ikea-vindriktning-with-tasmota-and-esphome/ title="Flashing the IKEA Vindriktning with Tasmota and ESPHome" hreflang=en>IKEA Vindriktning in HA</a></li><li class=heading><a href=/shoppinglist/ title=Shopping>Shopping</a></li><li class=heading><a href=/privacy/ title=Privacy>Privacy</a></li></ul></nav><a target=_blank class=social title="Atom Feed" href=/atom.xml><svg width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg>
</a><a href=https://bsky.app/profile/sequr.be target=_blank class="u-url social" rel="external noopener me" title=Bluesky><svg width="1.2em" height="1.2em" viewBox="0 0 568 501"><path fill="currentcolor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873c25.719-53.192 95.759-152.3204 160.879-201.2093C491.866-1.61183 568-28.9064 568 57.9464 568 75.2916 558.055 203.659 552.222 224.501c-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281C285.169 375.812 284.017 372.431 284 375.306 283.983 372.431 282.831 375.812 280.369 383.039c-13.43 39.422-65.842 193.273-185.7023 70.281C31.5556 388.56 60.7778 323.8 175.653 304.249 109.933 315.434 36.0535 296.954 15.7778 224.501 9.94525 203.659.0 75.2916.0 57.9464.0-28.9064 76.1345-1.61183 123.121 33.6637z"/></svg></a><a href=https://mastodon-belgium.be/@TerraGloba target=_blank class="u-url social" rel="external noopener me" title=Mastodon><svg width="1.2em" height="1.2em" viewBox="0 0 24 24"><path fill="currentcolor" d="M20.94 14c-.28 1.41-2.44 2.96-4.97 3.26-1.31.15-2.6.3-3.97.24-2.25-.11-4-.54-4-.54v.62c.32 2.22 2.22 2.35 4.03 2.42 1.82.05 3.44-.46 3.44-.46l.08 1.65s-1.28.68-3.55.81c-1.25.07-2.81-.03-4.62-.5-3.92-1.05-4.6-5.24-4.7-9.5l-.01-3.43c0-4.34 2.83-5.61 2.83-5.61C6.95 2.3 9.41 2 11.97 2h.06c2.56.0 5.02.3 6.47.96.0.0 2.83 1.27 2.83 5.61.0.0.04 3.21-.39 5.43M18 8.91c0-1.08-.3-1.91-.85-2.56-.56-.63-1.3-.96-2.23-.96-1.06.0-1.87.41-2.42 1.23l-.5.88-.5-.88c-.56-.82-1.36-1.23-2.43-1.23-.92.0-1.66.33-2.23.96C6.29 7 6 7.83 6 8.91v5.26h2.1V9.06c0-1.06.45-1.62 1.36-1.62 1 0 1.5.65 1.5 1.93v2.79h2.07V9.37c0-1.28.5-1.93 1.51-1.93.9.0 1.35.56 1.35 1.62v5.11H18V8.91z"/></svg></a><a href=https://github.com/TheGroundZero target=_blank class="u-url social" rel="external noopener me" title=Github><svg width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a href=https://twitter.com/DezeStijn target=_blank class="u-url social" rel="external noopener me" title=Twitter><svg width="1.2em" height="1.2em" viewBox="0 0 16 16"><path fill="currentcolor" d="M5.032 14.286c6.037.0 9.34-4.837 9.34-9.032.0-.137.0-.274-.01-.41A6.56 6.56.0 0016 3.2c-.6.256-1.235.425-1.885.5a3.207 3.207.0 001.443-1.757c-.645.37-1.35.63-2.085.77a3.322 3.322.0 00-1.862-.958 3.384 3.384.0 00-2.082.334 3.223 3.223.0 00-1.442 1.49 3.08 3.08.0 00-.208 2.03 9.57 9.57.0 01-3.747-.963A9.269 9.269.0 011.114 2.292a3.086 3.086.0 00-.36 2.314c.189.787.68 1.475 1.376 1.924A3.344 3.344.0 01.64 6.132v.04c0 .734.263 1.444.743 2.01a3.3 3.3.0 001.89 1.102c-.483.128-.99.146-1.482.055a3.19 3.19.0 001.168 1.577 3.36 3.36.0 001.9.627A6.732 6.732.0 010 12.86a9.527 9.527.0 005.032 1.423"/></svg></a><a href=https://ko-fi.com/s4squatch target=_blank class="u-url social" rel="external noopener" title=Kofi><svg width="1.2em" height="1.2em" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M23.881 8.948c-.773-4.085-4.859-4.593-4.859-4.593H.723c-.604.0-.679.798-.679.798s-.082 7.324-.022 11.822c.164 2.424 2.586 2.672 2.586 2.672s8.267-.023 11.966-.049c2.438-.426 2.683-2.566 2.658-3.734 4.352.24 7.422-2.831 6.649-6.916zm-11.062 3.511c-1.246 1.453-4.011 3.976-4.011 3.976s-.121.119-.31.023c-.076-.057-.108-.09-.108-.09-.443-.441-3.368-3.049-4.034-3.954-.709-.965-1.041-2.7-.091-3.71.951-1.01 3.005-1.086 4.363.407.0.0 1.565-1.782 3.468-.963 1.904.82 1.832 3.011.723 4.311zm6.173.478c-.928.116-1.682.028-1.682.028V7.284h1.77s1.971.551 1.971 2.638c0 1.913-.985 2.667-2.059 3.015z"/></svg></a><p class=footnote>&copy; 2019
• <a class="p-name u-url" href=https://sequr.be>Sequr</a>
• <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="external noopener">CC BY-NC-SA 4.0</a></p><a href=https://sequr.be/en hreflang=en-US title=English class=u-translation-of rel=alternate><span class="flag fi fi-gb"></span>
</a><a href=https://sequr.be/nl hreflang=nl-BE title=Nederlands class=u-translation-of rel=alternate><span class="flag fi fi-nl"></span></a></div></aside><section class="content container"><article class="post h-entry"><header class=info><h1 class="post-title p-name u-url"><a href=https://sequr.be/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/ rel=bookmark>Room temperature monitoring using Xiaomi temperature sensor, ESP32 and ESPHome</a></h1><div class=headline><div><span class="h-card p-author">DezeStijn
</span><span class=whitespace>• </span><time datetime=2021-01-12T19:00:00+0100 class="post-date dt-published">Jan 12, 2021
</time><span class=whitespace></span><time datetime=2021-05-18T01:00:00+0100 class="post-date dt-updated">(May 18, 2021)
</time><span class=whitespace>• </span><span class=reading-time><span>15 mins read</span></span></div><ul class=tags><li class="tag-Home Automation"><a class=p-category href=https://sequr.be/categories/home-automation>Home Automation</a></li></ul></div></header><main class=e-content><p>At home I have a few <a href=https://shelly.cloud/products/shelly-humidity-temperature-smart-home-automation-sensor/ title="Shelly Humidity & Temperature sensor" rel=external target=_blank>Shelly H&amp;T</a> sensors.
These sensors provide me with a regular update on the temperature and humidity in a room.
They look pretty nice and are tiny, so they can be placed just about anywhere without drawing too much attention.
They currently sell in a white/blue and a black/orange variant for about €24, with an optional USB-powered base replacing the CR123A battery sold for €5.<br>I have one of these on each floor for general temperature monitoring.</p><p>Recently, I came accross a video by Intermit.Tech (<a href=https://blog.quindorian.org/2020/10/4-xiaomi-temperature-sensor-for-home-assistant.html/ title="4$ Xiaomi Temperature Sensor for Home Assistant" rel=external target=_blank>Quindor</a>) on setting up temperature and humidity monitoring using cheap $4 Xiaomi sensors.
These sensors are also pretty tiny, but come with a LCD-screen displaying the sensor data.
Their sensor is also pre-calibrated and the devices are optimized for running on battery power.<br>Because of their small size, and more importantly their small price, they&rsquo;re ideal for per-room temperature monitoring.</p><figure class=center><img src=xiaomi_sensor_LYWSD03MMC.png alt="Xiaomi LYWSD03MMC temperature and humidity sensor"><figcaption class=center>Xiaomi LYWSD03MMC sensor</figcaption></figure><p>Since they send their data over Bluetooth Low-Energy (BLE) you&rsquo;re supposed to use the companion app to get the readings.</p><p>In this blogpost I&rsquo;ll explain how to add the Xiaomi thermometers to Home Assistant using an ESP32 board to capture the bluetooth data and ESPHome to import the data in Home Assistant.
I&rsquo;ll discuss flashing the Xiaomi LYWSD03MMC sensors with custom firmware, integrating the Xiaomi LYWSDCGQ, getting the bindkey for the Xiaomi CGG1 running the newer firmware, and setting the clock on the Xiaomi LYWSD02 without using the MiHome app.</p><h2 id=parts-needed-shopping-list>Parts needed (shopping list)</h2><p>For this tutorial, you&rsquo;ll need:</p><ul><li>One or more Xiaomi sensors.
They come in different shapes and sizes.<ul><li>Small square with LCD <a href=https://s.click.aliexpress.com/e/_Ac9pCh title="Xiaomi Bluetooth Temperature Humidity Sensor LYWSD03MMC" rel=external target=_blank>LYWSD03MMC</a><br><strong>Note:</strong> These can (optionally) be flashed, <a href=/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/#getting-the-bindkey-of-the-lywsd03mmc-and-flashing-custom-firmware title="Getting the bindkey of the LYWSD03MMC and flashing custom firmware">see below</a>.</li><li>Round with LCD <a href=https://s.click.aliexpress.com/e/_A9CVgh title="Xiaomi Bluetooth Temperature Humidity Sensor LYWSDCGQ" rel=external target=_blank>LYWSDCGQ</a><br><strong>Note:</strong> I did not test these yet</li><li>Round with E-ink <a href=https://s.click.aliexpress.com/e/_APk8YN title="Xiaomi Bluetooth Temperature Humidity Sensor CGG1" rel=external target=_blank>CGG1</a><br><strong>Note:</strong> You&rsquo;ll need to obtain the bindkey via a modded app, <a href=/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/#getting-the-bindkey-of-the-cgg1 title="Getting the bindkey of the CGG1">see below</a>.</li><li>Rectangular with E-ink <a href=https://s.click.aliexpress.com/e/_AKn1BJ title="Xiaomi Bluetooth Temperature Humidity Sensor LYWSD02" rel=external target=_blank>LYWSD02</a><br><strong>Note:</strong> These work out-of-the-box but you&rsquo;ll need to <a href=/blog/2021/01/room-temperature-monitoring-using-xiaomi-temperature-sensor-esp32-and-esphome/#setting-the-clock-on-the-lywsd02 title="Setting the clock on the LYWSD02">set the clock</a>.</li></ul></li><li>An ESP-board with BLE chip<ul><li><a href=https://s.click.aliexpress.com/e/_97FTTR title="MH-ET LIVE ESP32 Development Board WiFi+Bluetooth" rel=external target=_blank>MH-ET LIVE ESP32</a></li></ul></li><li>A USB power supply for the ESP32<ul><li><a href=https://s.click.aliexpress.com/e/_AcyKgH title="CHOETECH Quick Charge 3.0 18W USB Wall Charger" rel=external target=_blank>CHOETECH Quick Charge 3.0 18W</a></li></ul></li><li>A micro-USB cable to to flash and power the ESP32<ul><li><a href=https://s.click.aliexpress.com/e/_APUlNb title="Baseus Micro USB Cable" rel=external target=_blank>Baseus Reversible Micro USB Cable</a></li></ul></li></ul><h2 id=flashing-the-esp32>Flashing the ESP32</h2><p>If you got a brand new ESP32 board, you&rsquo;ll need to flash it once over USB to get it setup to work with ESPHome.
Once this flashing is done, you&rsquo;ll be able to push any future updates Over-The-Air (OTA).</p><h3 id=esphome>ESPHome</h3><p>We&rsquo;ll be writing our code for the ESP32 in <a href=https://esphome.io title=ESPHome rel=external target=_blank>ESPHome</a>.
So make sure you&rsquo;ve installed the ESPHome Add-on in Home Assistant.<br>The ESPHome website has a <a href=https://esphome.io/guides/getting_started_hassio.html title="ESPHome - Getting Started with ESPHome and Home Assistant" rel=external target=_blank>tutorial</a> on installing this add-on in Home Assistant.</p><h3 id=flashing-bluetooth-discovery-firmware>Flashing bluetooth discovery firmware</h3><ol><li><p>In ESPHome, create a new device by clicking the big <code>+</code> button.<br>The details you enter here don&rsquo;t matter too much. Just make sure you give it a reasonable name (this will also be used to name the config file).
E.g., <code>livingroom_esp32</code></p></li><li><p>Now edit the device and overwrite the config with the following code.
Change the back to what you originally named the device.<br>You can enter the WiFi credentials directly in the config, or make use of the secrets file (see below).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>substitutions</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>esphome_name</span>: <span style=color:#ae81ff>livingroom_esp32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${esphome_name}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>ESP32</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>board</span>: <span style=color:#ae81ff>mhetesp32devkit</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>wifi</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssid</span>: !<span style=color:#ae81ff>secret wifi_ssid</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret wifi_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>api</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>reboot_timeout</span>: <span style=color:#ae81ff>60min</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret esphome_api_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sync time with HA</span>
</span></span><span style=display:flex><span><span style=color:#f92672>time</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>homeassistant</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Optional</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#web_server:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    port: 80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>ota</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret esphome_ota_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>logger</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Enable Bluetooth scanning for this ESP32</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esp32_ble_tracker</span>:
</span></span></code></pre></div><p>Save and Close the editor.</p></li><li><p>Now click the 3 dots in the upper right corner of your device and click <code>Compile</code>.<br>This will compile the code into a firmware binary that we can download to our computer.</p></li><li><p>While the code is compiling, download and install the <a href=https://github.com/esphome/esphome-flasher/releases title=ESPHome-Flasher rel=external target=_blank>ESPHome-Flasher</a> for your system.
This software will be used for the initial flashing over USB. Future updates will be done Over-The-Air (OTA).</p></li><li><p>We&rsquo;ll now flash the compiled firmware to the ESP32.</p><ol><li>Connect the ESP32 using a micro-USB cable to your computer</li><li>Open ESPHome-Flasher</li><li>Click the refresh button at the top-right</li><li>Select the COM port your ESP32 is connected to</li><li>Browse to the firmware we&rsquo;ve just compiled and download to our computer</li><li>Click <code>Flash ESP</code></li></ol><p>If the flashing software is unable to put the ESP32 in <em>flash mode</em>, hold down the <em>Boot</em> button on the ESP32 while it&rsquo;s trying to flash.<br>Once the flashing has started, you can let go of the <em>Boot</em> button.</p></li><li><p>Once it&rsquo;s done flashing, the ESP32 will connect to your WiFi network and you&rsquo;ll be able to control the ESP32 Over-The-Air using ESPHome.</p></li></ol><h3 id=flashing-sensor-firmware>Flashing sensor firmware</h3><p>You can now disconnect the ESP32 and install it where it will be able to receive the bluetooth data of your sensors.
Power it using a phone charger, like the one in the Shopping List above.</p><ol><li>Back in the ESPHome dashboard, you can now click the <code>LOGS</code> button to view the output of the ESP32 board.<br>In the past you&rsquo;d see broadcast messages containing temperature and humidity information, including the device&rsquo;s MAC address.
Nowadays you&rsquo;ll need to look for lines <code>Found device XX:XX:XX:XX:XX:XX (...) Name: 'xxxxxxxxxx'</code>.
You&rsquo;ll want to note down the MAC address of the ATC device (if flashed) or with the original name (e.g., LYWSD03MMC).<br><figure class=center><img src=esphome_bletracker.png alt="BLE_tracker showing discovered devices"><figcaption class=center>BLE_tracker output</figcaption></figure><br><strong>Note:</strong> To make identifying the correct Xiaomi device easier, make sure the others are out of bluetooth range or are turned off.
You may also want to label each sensor after you&rsquo;ve identified it.</li><li>We&rsquo;ll now edit the device&rsquo;s code again and add the sensor entities for the Xiaomi sensor(s) we&rsquo;ll be monitoring.<br>Open the config editor and paste the following code below the code we already had:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Add this to the substitions block:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># substitutions:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsd03</span>: <span style=color:#ae81ff>Living room</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsd02</span>: <span style=color:#ae81ff>Kitchen</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_cgg1</span>: <span style=color:#ae81ff>Master Bedroom</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsdcgq</span>: <span style=color:#ae81ff>Office</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>switch</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>gpio</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Onboard LED&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>pin</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>inverted</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>restart</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Restart&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>restart_switch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>sensor</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># General</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>uptime</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Uptime Sensor&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>wifi_signal</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - WiFi Signal&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>update_interval</span>: <span style=color:#ae81ff>60s</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD03MMC - Advertising Type: Mi Like</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsd03mmc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindkey</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span> <span style=color:#75715e># Replace with bind key, use a dummy value when flashed with custom firmware</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD03MMC - Advertising Type: Custom</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>atc_mithermometer</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery-Level&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_voltage</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery-Voltage&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD02</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsd02</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>		<span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># CGG1</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_cgg1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindkey</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span> <span style=color:#75715e># Replace with bind key, requires different ESPHome_version</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSDCGQ</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsdcgq</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Remove or add extra sensors by deleting/copying any of the blocks above.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Change MAC address, bindkey and sensor names</span>
</span></span></code></pre></div></li><li>Press the <code>Upload</code> bottom at the bottom right of the editor.<br>This will save, compile and upload the new firmware to the ESP32 (OTA).</li></ol><h3 id=storing-wifi-creds-and-otaapi-passwords-in-secret-file>Storing WiFi creds and OTA/API passwords in secret file</h3><p>Just like with Home Assistant, ESPHome has a <code>secrets.yaml</code> in which you can store stuff like WiFi credentials.<br>This allows you to keep secret data away from your config files and also adds consistency accross your devices.</p><p>To make things even easier, you can reference your Home Assistant <code>secrets.yaml</code> from the ESPHome&rsquo;s one, allowing you to keep everything in one central location.</p><p>Create a file <code>/config/esphome/secrets.yaml</code> with the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>&lt;&lt;</span>: !<span style=color:#ae81ff>include ../secrets.yaml</span>
</span></span></code></pre></div><p>Now in <code>/config/secrets.yaml</code> you can add your WiFi credentials etc.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>wifi_ssid</span>: <span style=color:#e6db74>&#34;MyVerySecretWiFiNetwork&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>wifi_pass</span>: <span style=color:#e6db74>&#34;MyverySecretWiFiPassword&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome_ota_pass</span>: <span style=color:#e6db74>&#34;SecretEsphomeOtaPass&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome_api_pass</span>: <span style=color:#e6db74>&#34;SecretEsphomeApiPass&#34;</span>
</span></span></code></pre></div><p>You can now reference these secrets from your config using e.g. <code>ssid: !secret wifi_ssid</code>.</p><h2 id=adding-the-sensors-in-home-assistant>Adding the sensors in Home Assistant</h2><p>Adding the sensors to Home Assistant is really easy.
If the sensor for some reason doesn&rsquo;t show up yet in the guide below, give Home Assistant a reboot and wait a few minutes.</p><ol><li>In Home Assistant, go to Configuration > Integrations.</li><li>If the ESP32 isn&rsquo;t automatically discovered yet by Home Assistant, click the big <code>+</code> button to add a new integration.<br>Choose ESPHome from the list.</li><li>Enter the IP address or hostname of your ESP32 board, keep the port in its default value.</li><li>Enter your API and/or OTA password.</li><li>Add the device to a room if you wish to do so.</li></ol><p>Within the Configuration page you should now see an entry for your device (livingroom_esp32) under ESPHome.<br>Clicking this device will show you the different sensors for the temperature, humidity and battery level.
You should also have a switch to turn on the onboard LED (useful to identify the device) and to reboot it.
You may also have a sensor for the WiFi signal strength and device uptime.</p><p>It may take a while before sensor data will appear for the device.<br>Since the sensors are battery powered, it may take until a certain temperature change (or the next update interval).</p><p><figure class=center><img src=xiaomi_ha_esphome.png alt="ESPHome entities in Home Assistant"><figcaption class=center>ESPHome entities in Home Assistant</figcaption></figure><figure class=center><img src=xiaomi_ha_esphome_temp.png alt="Temperature readings"><figcaption class=center>Temperature readings</figcaption></figure></p><h2 id=device-specific-configurations>Device specific configurations</h2><h3 id=getting-the-bindkey-of-the-lywsd03mmc-and-flashing-custom-firmware>Getting the bindkey of the LYWSD03MMC and flashing custom firmware</h3><p>Sadly enough, more recent models of the Xiaomi (LYWSD03MMC) sensors come with a new firmware that encrypts the data send over bluetooth.
Luckily Aaron Christophel came up with a nice way of <a href=https://github.com/atc1441/ATC_MiThermometer title="atc1441/ATC_MiThermometer on GitHub" rel=external target=_blank>hacking</a> the firmware on these sensors.
Not only does his <em>hack</em> provide a method of retrieving the bluetooth encryption key (allowing us to decrypt the data) but he even wrote his own firmware.
Using Aaron&rsquo;s <a href=https://github.com/atc1441/ATC_MiThermometer title="atc1441/ATC_MiThermometer on GitHub" rel=external target=_blank>ATC_MiThermometer</a> firmware, you can also control the update interval, allowing you to choose sensor update frequency over battery life.</p><p><strong>Update 2021-05-18</strong>: There&rsquo;s <a href=https://github.com/pvvx/ATC_MiThermometer title="pvvx/ATC_MiThermometer on GitHub" rel=external target=_blank>a fork</a> of Aaron&rsquo;s firmware which appears to offer more functions including non-volatile storage and a better low power management.
To use this version, follow the same steps as below but grab the binary from Victor&rsquo;s repository.</p><figure class=center><img src=ATC_MiThermometer.png alt="ATC MiThermometer by Aaron Christophel"><figcaption class=center>ATC MiThermometer</figcaption></figure><p><strong>Note:</strong> Flashing the custom firmware isn&rsquo;t strictly necessary to get the sensor data imported into Home Assistant.<br>If you don&rsquo;t feel like flashing the sensor, follow the guide below until step 5 and skip the rest of the flashing.</p><p>The flashing will be done from the browser a phone or tablet, since you need to connect to the sensor over bluetooth.<br>Use the default browser of the device or the Chrome browser.
If it doesn&rsquo;t work with one device, try it again on another.<br>I had issues trying this on a OnePlus and Firefox. It succeeded using a Samsung Galaxy Tab and its default browser.</p><ol><li><p>Get the <code>ATC_MiThermometer.bin</code> binary from <a href=https://github.com/atc1441/ATC_MiThermometer title="atc1441/ATC_MiThermometer on GitHub" rel=external target=_blank>Aaron&rsquo;s GitHub</a> and save it to your phone/tablet.</p></li><li><p>Still on the GitHub page, at the top of the Readme documentation, you&rsquo;ll find a link to the Web Flasher tool also written by Aaron.
Open this link in the default/Chrome browser of your phone/tablet.</p></li><li><p>On the Web Flasher page, check the <code>Hide unsupported</code> checkbox and click <code>Connect</code>.</p></li><li><p>From the popup that should now have appeared, select the sensor you want to flash.
The name should match the device ID from the shopping list above (e.g., <code>LYWSD03MMC</code>).<br>Once connected, the &ldquo;Temp/Humi&rdquo; field &ndash; located about halfway the webpage &ndash; should be displaying sensor readings.
At the bottom of the page, the logs should also show the device having connected.</p></li><li><p>Press the <code>Do activation</code> button.<br>A Mi Token and Mi Bind Key should appear a bit below the &ldquo;Temp/Humi&rdquo; field of the previous step.<br>Note these down (or copy them into an email, Google Keep note, &mldr;) in a way that you can easily get to them from your computer/laptop.<br>This token and key are what you need to import the Xiaomi sensor into Home Assistant without flashing the custom firmware.</p><p><strong>If you don&rsquo;t want to flash the Xiaomi sensor with the custom firmware, stop here and continue with the next part.</strong></p></li><li><p>Below the &ldquo;Do activation&rdquo; button, there&rsquo;s a <code>Choose File</code> button.<br>Press this button and select the <code>ATC_MiThermometer.bin</code> you downloaded earlier.<br>Make sure to select the correct file here, or you may/will brick the sensor!</p></li><li><p>Press the <code>Start Flashing</code> button.<br>You&rsquo;ll see that status of the flashing appearing below the button.
Don&rsquo;t use the phone for now, it&rsquo;ll only take a minute or so.</p></li><li><p>Once the update is succesful, press the <code>Connect</code> button again and look for the flashed sensor.<br>The device should now appear as <code>ATC_xxxxxx</code>.
The logs at the bottom of the page should show you that you&rsquo;ve connected to the device.</p></li><li><p>Using the newly acquired features, we can now change some settings on the device.<br>Note that the changes don&rsquo;t always go through to the device, so press each button like 5 times to make sure it was set succesfully.</p><ol><li>set the <code>Advertising Type</code> to <code>Mi Like</code><br><strong>Note</strong>: Since ESPHome <a href=https://github.com/esphome/esphome/pull/1291 title="ESPHome on GitHub - Add support for ATC_MiThermometer #1291" rel=external target=_blank>v1.16.0</a> <code>Advertising Type: Custom</code> is supported.</li><li>set the <code>Advertising Interval</code> to your liking. Shorter interval means shorter battery life but less detailed measurements.</li></ol></li></ol><h3 id=getting-the-bindkey-of-the-cgg1>Getting the bindkey of the CGG1</h3><figure class=center><img src=xiaomi_sensor_CGG1.png alt="Xiaomi CGG1"><figcaption class=center>Xiaomi CGG1</figcaption></figure><h4 id=mihome-mod-app>MiHome Mod app</h4><p><strong>Note:</strong> These steps must be followed with an Android device</p><ol><li>Download the <a href=https://www.kapiba.ru/2017/11/mi-home.html title="MiHome Mod" rel=external target=_blank>MiHome mod</a> apk.<br>The site is in Russian, so use Google Translate to translate if needed.</li><li>Configure your device to allow installation of untrusted sources.</li><li>While installing the app, grant permission to the local device storage</li><li>Once you open the app, a new folder will be created: <code>/devicestorage/vevs</code>.</li><li>Close the app and create a new folder within this folder: <code>/devicestorage/vevs/logs</code></li><li>Open the app again and login with your Mi account.</li><li>Add the CGG1 in the app.</li><li>The bindkey is now stored on your device.<br>Transfer <code>/devicestorage/vevs/logs/misc/pairings.txt</code> to your computer (over USB/bluetooth).</li><li>Extract the bindkey from the file you just transfered.</li></ol><p>The <code>pairings.txt</code> will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-txt data-lang=txt><span style=display:flex><span>Did:		blt.4.xxxxxxxxxxxxx
</span></span><span style=display:flex><span>Token:		xxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span style=display:flex><span>Bindkey:		xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span style=display:flex><span>Mac:		xx:xx:xx:xx:xx:xx
</span></span></code></pre></div><h4 id=esphome-1>ESPHome</h4><p><del>To use this bindkey in your configuration, you&rsquo;ll need to load an adapted version of ESPHome.</del></p><p><strong>Update 2021-05-18</strong>: Flameeyes&rsquo; code has been imported into the main ESPHome code base since <a href=https://esphome.io/changelog/v1.17.0.html#release-1-17-1-may-5 title="ESPHome - Changelog release 1.17.1" rel=external target=_blank>ESPHome v1.17.1</a>.
It&rsquo;s no longer necessary to move to Flameeyes&rsquo; codebase to configure the <code>bindkey</code> in your ESPHome config.</p><ol><li>Open the Supervisor Dashboard in Home Assistnat</li><li>Click the ESPHome add-on and go to the Configuration tab</li><li>Under &ldquo;esphome_version&rdquo; enter <code>Flameeyes:cgg1-enc</code><br><figure class=center><img src=esphome_version.png alt="ESPHome_version: Flameeyes:cgg1-enc"><figcaption class=center>Change esphome_version</figcaption></figure><br>In the YAML this would look like:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ssl</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>certfile</span>: <span style=color:#ae81ff>fullchain.pem</span>
</span></span><span style=display:flex><span><span style=color:#f92672>keyfile</span>: <span style=color:#ae81ff>privkey.pem</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome_version</span>: <span style=color:#e6db74>&#39;Flameeyes:cgg1-enc&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>relative_url</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span></code></pre></div></li><li>Save and restart the add-on</li></ol><p>You can now add a <code>bindkey</code> to the config/firmware.</p><h4 id=update-esp32><del>Update ESP32</del></h4><p>If you already had your ESP32 configured, you&rsquo;ll need to update it to the custom ESPHome_version.</p><ol><li>Open the ESPHome dashboard.</li><li>You&rsquo;ll see the Update symbol at the top-right of the device&rsquo;s entry.</li><li>To update, click the 3 dots at the top-right of your screen and click &ldquo;Update All&rdquo;.<br><figure class=center><img src=esphome_update.png alt="ESPHome - Update all"><figcaption class=center>Update All</figcaption></figure></li></ol><h3 id=setting-the-clock-on-the-lywsd02>Setting the clock on the LYWSD02</h3><figure class=center><img src=xiaomi_sensor_LYWSD02.png alt="Xiaomi LYWSD02"><figcaption class=center>Xiaomi LYWSD02</figcaption></figure><p>The LYWSD02 also displays the current time.</p><p>Normally you need to install the MiHome app to sync the time.
But installing a Chinese app just to sync the time on your sensors, might seem a bit useless.
Luckily, another fantastic Github user, saso5, created a simple web app that allows you to set the time on your LYWSD02.</p><ul><li>Visit <a href=https://saso5.github.io/LYWSD02-clock-sync/ rel=external target=_blank>https://saso5.github.io/LYWSD02-clock-sync/</a> with the same device you used to flash your LYWSD03.</li><li>Pick your timezone (between UTC/GMT-12 and UTC/GMT+14)</li><li>Click the <code>Update time</code> button</li><li>Select the LYWSD02 in the popup that appears and click <code>Connect</code></li></ul><p>The time on your LYWSD02 should now be correct.</p><p>Make sure you close the browser tab and disconnect your device from the Xiaomi.<br>Otherwise your device will &ldquo;claim&rdquo; the Bluetooth connection and the ESP32 won&rsquo;t be able to connect.</p><p>There&rsquo;s a <a href=https://github.com/esphome/feature-requests/issues/643 title="Set clock on Xiaomi LYWSD02 #643 on GitHub" rel=external target=_blank>feature request</a> on the ESPHome GitHub to have the LYWSD02 sync with an SNTP server.</p><h2 id=full-esp32-configuration>Full ESP32 configuration</h2><p>The complete configuration file looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>substitutions</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>esphome_name</span>: <span style=color:#ae81ff>livingroom_esp32</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsd03</span>: <span style=color:#ae81ff>Living room</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsd02</span>: <span style=color:#ae81ff>Kitchen</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_cgg1</span>: <span style=color:#ae81ff>Master Bedroom</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sensor_name_lywsdcgq</span>: <span style=color:#ae81ff>Office</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>esphome</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${esphome_name}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>ESP32</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>board</span>: <span style=color:#ae81ff>mhetesp32devkit</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>wifi</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssid</span>: !<span style=color:#ae81ff>secret wifi_ssid</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret wifi_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>api</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>reboot_timeout</span>: <span style=color:#ae81ff>60min</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret esphome_api_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>ota</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: !<span style=color:#ae81ff>secret esphome_ota_pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sync time with HA</span>
</span></span><span style=display:flex><span><span style=color:#f92672>time</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>homeassistant</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Optional</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#web_server:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    port: 80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>logger</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Enable Bluetooth scanning for this ESP32</span>
</span></span><span style=display:flex><span><span style=color:#f92672>esp32_ble_tracker</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>switch</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>gpio</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Onboard LED&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>pin</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>inverted</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>restart</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Restart&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>restart_switch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>sensor</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># General</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>uptime</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - Uptime Sensor&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>wifi_signal</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${esphome_name} - WiFi Signal&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>update_interval</span>: <span style=color:#ae81ff>60s</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD03MMC - Advertising Type: Mi Like</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsd03mmc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindkey</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span> <span style=color:#75715e># Replace with bind key, use a dummy value when flashed with custom firmware</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery Level&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD03MMC - Advertising Type: Custom</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>atc_mithermometer</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery-Level&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_voltage</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd03} - Battery-Voltage&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSD02</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsd02</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsd02} Battery Level&#34;</span>
</span></span><span style=display:flex><span>    	
</span></span><span style=display:flex><span>    <span style=color:#75715e># CGG1</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_cgg1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>bindkey</span>: <span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span> <span style=color:#75715e># Replace with bind key, requires different ESPHome_version</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_cgg1} Battery Level&#34;</span>
</span></span><span style=display:flex><span>    	
</span></span><span style=display:flex><span>    <span style=color:#75715e># LYWSDCGQ</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>xiaomi_lywsdcgq</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>mac_address</span>: <span style=color:#e6db74>&#34;XX:XX:XX:XX:XX:XX&#34;</span> <span style=color:#75715e># Replace with MAC Address of sensor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>temperature</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Temperature&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>humidity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Humidity&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>battery_level</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;${sensor_name_lywsdcgq} Battery Level&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#75715e># Remove or add extra sensors by deleting/copying any of the blocks above.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Change MAC address, bindkey and sensor names</span>
</span></span></code></pre></div><h2 id=changelog>Changelog</h2><ul><li>2020-02-09 - Newer versions of CGG1 have encrypted Bluetooth messages. Flameeyes:cgg1-enc firmware adds support for bindkey.</li><li>2021-02-14 - ESPHome v1.16.0 adds support for ATC_MiThermometer using Advertising Type: Custom</li><li>2021-05-18 - Flameeyes:cgg1-enc merged into main ESPHome codebase to support CGG1 with bindkey. ATC_MiThermometer fork adds extra features.</li></ul></main><hr><footer><div class=footer><p><div class=previous-post><a href="https://sequr.be/blog/2020/11/force-update/downgrade-shelly-firmware/?ref=footer"><span style=font-weight:700>« Previous</span><br>Force update/downgrade Shelly firmware</a><div class=next-post><a href="https://sequr.be/blog/2021/01/circadian-lighting-with-ikea-tradfri-lightbulbs-and-home-assistant/?ref=footer"><span style=font-weight:700>Next »</span><br>Circadian lighting with IKEA TRADFRI lightbulbs...</a></div></p></div></footer></article></section><aside class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#parts-needed-shopping-list>Parts needed (shopping list)</a></li><li><a href=#flashing-the-esp32>Flashing the ESP32</a><ul><li><a href=#esphome>ESPHome</a></li><li><a href=#flashing-bluetooth-discovery-firmware>Flashing bluetooth discovery firmware</a></li><li><a href=#flashing-sensor-firmware>Flashing sensor firmware</a></li><li><a href=#storing-wifi-creds-and-otaapi-passwords-in-secret-file>Storing WiFi creds and OTA/API passwords in secret file</a></li></ul></li><li><a href=#adding-the-sensors-in-home-assistant>Adding the sensors in Home Assistant</a></li><li><a href=#device-specific-configurations>Device specific configurations</a><ul><li><a href=#getting-the-bindkey-of-the-lywsd03mmc-and-flashing-custom-firmware>Getting the bindkey of the LYWSD03MMC and flashing custom firmware</a></li><li><a href=#getting-the-bindkey-of-the-cgg1>Getting the bindkey of the CGG1</a><ul><li><a href=#mihome-mod-app>MiHome Mod app</a></li><li><a href=#esphome-1>ESPHome</a></li><li><a href=#update-esp32><del>Update ESP32</del></a></li></ul></li><li><a href=#setting-the-clock-on-the-lywsd02>Setting the clock on the LYWSD02</a></li></ul></li><li><a href=#full-esp32-configuration>Full ESP32 configuration</a></li><li><a href=#changelog>Changelog</a></li></ul></nav></div></aside></div></body></html>